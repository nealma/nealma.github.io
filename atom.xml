<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>nealma.com</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.nealma.com/"/>
  <updated>2017-12-04T04:18:06.192Z</updated>
  <id>http://www.nealma.com/</id>
  
  <author>
    <name>马英乘Neal</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Ansible（三) Ansible Tower</title>
    <link href="http://www.nealma.com/2017/11/30/ansible-3-tower/"/>
    <id>http://www.nealma.com/2017/11/30/ansible-3-tower/</id>
    <published>2017-11-30T03:46:45.000Z</published>
    <updated>2017-12-04T04:18:06.192Z</updated>
    
    <content type="html"><![CDATA[<pre><code>总是在命令行里面操作不是长久之计，还是有个web控制台来控制好些。
Ansible Tower给我们提供了便利，还是挺方便的。
</code></pre><a id="more"></a>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><pre><code>[下载地址](http://releases.ansible.com/ansible-tower/setup/)
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">wget http://releases.ansible.com/ansible-tower/setup/ansible-tower-setup-latest.tar.gz</div><div class="line">tar xvf ansible-tower-setup-latest.tar.gz </div><div class="line">cd ansible-tower-setup-3.2.1/</div><div class="line"></div><div class="line"># 修改配置信息 </div><div class="line">sed -i &quot;s#password=&apos;&apos;#password=&apos;admin&apos;#g&quot; inventory</div><div class="line">sed -i &quot;s#host=&apos;&apos;#host=&apos;127.0.0.1&apos;#g&quot; inventory </div><div class="line">sed -i &quot;s#port=&apos;&apos;#port=&apos;5432&apos;#g&quot; inventory</div><div class="line"></div><div class="line"># 安装postgresql数据库，查看我的另一篇关于postgesql的文章</div><div class="line"></div><div class="line"># 创建用户</div><div class="line">su - postgres</div><div class="line">psql</div><div class="line">CREATE ROLE awx CREATEDB PASSWORD &apos;admin&apos; LOGIN; </div><div class="line">\q</div><div class="line">sed -i &apos;s#peer#md5#g&apos; /var/lib/pgsql/9.5/data/pg_hba.conf</div><div class="line">sed -i &apos;s#ident#md5#g&apos; /var/lib/pgsql/9.5/data/pg_hba.conf</div><div class="line"></div><div class="line"># 创建awx数据库</div><div class="line">psql -U awx -d postgres -h 127.0.0.1</div><div class="line">create database awx;</div><div class="line">\q</div><div class="line"></div><div class="line"></div><div class="line"># 正式安装</div><div class="line"></div><div class="line">./setup.py</div></pre></td></tr></table></figure>
<h3 id="登录tower"><a href="#登录tower" class="headerlink" title="登录tower"></a>登录tower</h3><ul>
<li><p>账号密码: admin/admin</p>
</li>
<li><p>导入license 没有的话，点击REQUEST LICENSE，去官方申请免费试用。</p>
</li>
<li><p>随便点点，熟悉下内容</p>
</li>
</ul>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>：）～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;总是在命令行里面操作不是长久之计，还是有个web控制台来控制好些。
Ansible Tower给我们提供了便利，还是挺方便的。
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Ansible" scheme="http://www.nealma.com/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="http://www.nealma.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible（二) 日常使用和模块</title>
    <link href="http://www.nealma.com/2017/11/29/ansible-2-setup-linux-main/"/>
    <id>http://www.nealma.com/2017/11/29/ansible-2-setup-linux-main/</id>
    <published>2017-11-29T03:46:45.000Z</published>
    <updated>2017-11-30T10:22:37.422Z</updated>
    
    <content type="html"><![CDATA[<pre><code>服务器实例少的时候我们直接ssh，然后通过shell脚本就可以日常维护了。
随着实例的增加，后期需要一个高度自动化的工具来完成日常运维。ansible就是干这个的。
可以：程序包安装、配置、服务启动；对主机批量操作；程序版本更新；监控；
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>服务器实例少的时候我们直接ssh，然后通过shell脚本就可以日常维护了。
随着实例的增加，后期需要一个高度自动化的工具来完成日常运维。ansible就是干这个的。
可以：程序包安装、配置、服务启动；对主机批量操作；程序版本更新；监控；
</code></pre><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo yum install -y ansible</div></pre></td></tr></table></figure>
<pre><code>配置文件：/etc/ansible/ansible.cfg

被控主机或组清单：/etc/ansible/hosts 
</code></pre><p><strong>ansible是基于ssh的，可以设置免密码登录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-copy-id  root@hostname</div></pre></td></tr></table></figure>
<p><strong>hello world</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible 10.27.143.116 -m command -a &apos;echo hello world&apos;</div></pre></td></tr></table></figure></p>
<pre><code>看到很简单的hello world，松了一口气吧，来看看每个字端的意思。

ansible用法：ansible  [-f forks] [-m module_name] [-a args]
</code></pre><h3 id="日常模块"><a href="#日常模块" class="headerlink" title="日常模块"></a>日常模块</h3><ul>
<li>user模块：</li>
</ul>
<p>例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m user -a &apos;name=neal state=present system=yes&apos;</div></pre></td></tr></table></figure></p>
<pre><code>在group_name组包含的被控端上创建用户，name为neal；

state=present表示创建用户，

state=absent时表示删除用户；

system=yes表示创建系统用户；
</code></pre><ul>
<li>group模块：</li>
</ul>
<p>例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m group -a &apos;name=group_namegroup gid=111 state=present system=yes&apos;</div></pre></td></tr></table></figure></p>
<p>在group_name组包含的被控端上创建组group_namegroup；</p>
<p>组id为111；</p>
<p>state=present表示创建组，state=absent时表示删除组；</p>
<p>syste=yes表示创建系统组，system=no表示创建的不是系统组；</p>
<ul>
<li>cron模块：</li>
</ul>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m cron -a &apos;name=&quot;neal crontab list&quot; minute=&quot;*/10&quot; job=&quot;/sbin/ntpdate 10.27.143.116 &amp;&gt;/dev/null&quot;&apos;</div></pre></td></tr></table></figure>
<p>在group_name组包含的被控端添加任务计划，每20分钟向10.27.143.116同步时间，并把输出丢进/dev/null；</p>
<p>name：计划任务的描述信息；</p>
<p>minute：分钟；</p>
<p>job：要进行的操作；</p>
<p>day：日（1-31，<em>，</em>/2,……）；</p>
<p>hour：小时（0-23，<em>，</em>/2，……）；</p>
<p>month：月（1-12，<em>，</em>/2，……）；</p>
<p>weekday：周（0-7，*，……）；</p>
<p>user：以哪个用户的身份执行；</p>
<p>若要删除之前在被控端部署的计划任务，只需指定name和state=absent即可；</p>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m cron -a &apos;name=&quot;neal crontab list&quot; state=absent&apos;</div></pre></td></tr></table></figure>
<ul>
<li>copy模块：</li>
</ul>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m copy -a &apos;src=/data/from.txt dest=/tmp/to.txt mode=600&apos;</div></pre></td></tr></table></figure>
<p>复制ansible控制端的wyf.txt文件到group_name组所指定的被控端的主机的/tmp目录下</p>
<p>src：源路径</p>
<p>dest：目标路径</p>
<p>mode：文件权限</p>
<ul>
<li>file模块：</li>
</ul>
<p>专门用来设定文件属性；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m file -a &apos;path=/tmp/www state=directory&apos;</div></pre></td></tr></table></figure>
<p>在group_name组定义的被控端的/tmp/下创建www目录，state指定文件属性为目录</p>
<p>group：定义文件/目录的属组</p>
<p>mode：定义文件/目录的权限</p>
<p>owner：定义文件/目录的属主</p>
<p>path：必选项，定义文件/目录的路径</p>
<p>recurse：递归的设置文件的属性，只对目录有效</p>
<p>src：要被链接的源文件的路径，只应用于state=link的情况</p>
<p>dest：被链接到的路径，只应用于state=link的情况</p>
<p>state：</p>
<p>=directory：如果目录不存在，创建目录</p>
<p>=file：即使文件不存在，也不会被创建</p>
<p>=link：创建软链接</p>
<p>=hard：创建硬链接</p>
<p>=touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间</p>
<p>=absent：删除目录、文件或者取消链接文件</p>
<ul>
<li>ping模块：</li>
</ul>
<p>用于确认和对象机器之间是否能够ping通，正常情况会返回pong；</p>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m ping</div></pre></td></tr></table></figure>
<p>ping group_name组定义的被控端；如果是可以通的则返回pong；</p>
<ul>
<li>yum模块：</li>
</ul>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m yum -a &apos;name=httpd  state=present&apos;</div></pre></td></tr></table></figure>
<p>在group_name组的被控端yum安装httpd；</p>
<p>config_file：yum的配置文件</p>
<p>disable_gpg_check：关闭gpg_check</p>
<p>disablerepo：不启用某个源</p>
<p>enablerepo：启用某个源</p>
<p>name：要进行操作的软件包的名字，也可以传递一个url或者一个本地的rpm包的路径</p>
<p>state：状态（present安装，absent卸载，lagroup_name最新的）</p>
<ul>
<li>service模块：</li>
</ul>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m service -a &apos;name=httpd state=started enabled=yes&apos;</div></pre></td></tr></table></figure>
<p>group_name组的所有被控端，启动httpd服务，开机启动（enabled）</p>
<p>enabled：[yes/no] 启动os后启动对应service的选项;是否开机启动</p>
<p>name:需要进行操作的service名字</p>
<p>state:[stared/stoped/restarted/reloaded] 服务最终操作后的状态。</p>
<ul>
<li>shell模块：</li>
</ul>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m shell -a &apos;sh /data/1.sh chdir=/data/www creates=/data/www/1.txt&apos;</div></pre></td></tr></table></figure>
<p>执行group_name组所有被控端，先切换到/data/www目录，如果/data/www/1.txt不存在，则执行/data/1.sh，</p>
<p>chdir：command一样的，运行shell之前cd到某个目录；</p>
<p>creates：跟command一样的，如果某个文件存在则不运行shell；</p>
<p>removes：跟command一样的，如果某个文件不存在则不运行shell；</p>
<ul>
<li>script模块：</li>
</ul>
<p>可以实现被控端上可以执行ansible控制端的脚本。</p>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m script -a &apos;/data/www/2.sh&apos;</div></pre></td></tr></table></figure>
<p>在group_name组所有被控端执行ansible控制端中/data/www/目录下的2.sh</p>
<ul>
<li>setup模块：</li>
</ul>
<p>用于收集远程主机的一些基本信息。</p>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible group_name -m setup</div></pre></td></tr></table></figure>
<p>收集group_name组所有主机的基本信息</p>
<h3 id="Playbooks"><a href="#Playbooks" class="headerlink" title="Playbooks"></a>Playbooks</h3><p><strong>核心元素</strong></p>
<p>Tasks:任务</p>
<p>Variables：变量</p>
<p>Templates：模板</p>
<p>Handlers:处理器</p>
<p>Roles:角色</p>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>：）～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;服务器实例少的时候我们直接ssh，然后通过shell脚本就可以日常维护了。
随着实例的增加，后期需要一个高度自动化的工具来完成日常运维。ansible就是干这个的。
可以：程序包安装、配置、服务启动；对主机批量操作；程序版本更新；监控；
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Ansible" scheme="http://www.nealma.com/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="http://www.nealma.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible（一) Setup On MacOS</title>
    <link href="http://www.nealma.com/2017/11/27/kafka-1-setup/"/>
    <id>http://www.nealma.com/2017/11/27/kafka-1-setup/</id>
    <published>2017-11-27T03:46:45.000Z</published>
    <updated>2017-11-30T07:56:58.451Z</updated>
    
    <content type="html"><![CDATA[<pre><code>以前没有用过Ansible，根据官网的文档折腾了一下，在MacOS上还是有点小曲折的。
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>以前没有用过Ansible，根据官网的文档折腾了一下，在MacOS上还是有点小曲折的。
</code></pre><h3 id="macOS-安装"><a href="#macOS-安装" class="headerlink" title="macOS 安装"></a>macOS 安装</h3><pre><code>一开始根据官网的文档，在centos上使用git源码安装，没成功；
算了，还是在自己的macOS上玩吧，之前已经安装了pip，那就用**pip install ansible**安装吧
得，装是安装好了，但是hosts文件却没有，本人不想手动创建该文件，故找到使用brew安装的方法。
谁知，得到的结果一样，还是乖乖的手动创建这个文件吧:(
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#1 install ansible</div><div class="line">brew install ansible</div><div class="line"></div><div class="line">#2 create the hosts </div><div class="line">mkdir -p /usr/local/etc/ansible</div><div class="line"></div><div class="line">#hosts文件内容： a.com</div><div class="line">vim /usr/local/etc/ansible/hosts</div><div class="line"></div><div class="line"></div><div class="line">#3 test</div><div class="line">ansible all -m ping</div><div class="line"></div><div class="line">#真不幸，找不到 [WARNING]: Unable to parse /etc/ansible/hosts as an inventory source</div><div class="line">#那就继续找怎么才能让ansible发现hosts文件呢？</div><div class="line"></div><div class="line">#4 ansible.cfg配置文件，1.5之后的读取顺序</div><div class="line"></div><div class="line">* ANSIBLE_CONFIG (一个环境变量)</div><div class="line">* ansible.cfg (位于当前目录中)</div><div class="line">* .ansible.cfg (位于家目录中)</div><div class="line">* /etc/ansible/ansible.cfg</div><div class="line"></div><div class="line"># 无语了，又出现了python的3770问题，还是算了吧，回归CentOS吧</div></pre></td></tr></table></figure>
<h3 id="CentOS-安装"><a href="#CentOS-安装" class="headerlink" title="CentOS 安装"></a>CentOS 安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#1</div><div class="line">sudo yum install ansible</div><div class="line"></div><div class="line">#2 hosts文件内容增加你的主机名，可以说域名、ip、或者你自己映射的别名</div><div class="line">#这里我增加一个ip，10.27.143.116</div><div class="line">vim /etc/ansible/hosts </div><div class="line"></div><div class="line">#3 test</div><div class="line">ansible all -m ping</div><div class="line"></div><div class="line">#10.27.143.116 | SUCCESS =&gt; &#123;</div><div class="line">#    &quot;changed&quot;: false, </div><div class="line">#    &quot;failed&quot;: false, </div><div class="line">#    &quot;ping&quot;: &quot;pong&quot;</div><div class="line">#&#125;</div></pre></td></tr></table></figure>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>：）～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;以前没有用过Ansible，根据官网的文档折腾了一下，在MacOS上还是有点小曲折的。
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Ansible" scheme="http://www.nealma.com/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="http://www.nealma.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>Nginx | Can&#39;t install nodejs on centos7</title>
    <link href="http://www.nealma.com/2017/08/05/nginx-example-work-4-centos7-nodejs/"/>
    <id>http://www.nealma.com/2017/08/05/nginx-example-work-4-centos7-nodejs/</id>
    <published>2017-08-05T02:46:45.000Z</published>
    <updated>2017-08-30T01:43:10.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>Can&apos;t install nodejs on centos7
</code></pre><a id="more"></a>
<h3 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Resolving Dependencies</div><div class="line">--&gt; Running transaction check</div><div class="line">---&gt; Package nodejs.x86_64 1:6.11.1-1.el7 will be installed</div><div class="line">--&gt; Processing Dependency: npm = 1:3.10.10-1.6.11.1.1.el7 for package: 1:nodejs-6.11.1-1.el7.x86_64</div><div class="line">--&gt; Processing Dependency: http-parser &gt;= 2.7.0 for package: 1:nodejs-6.11.1-1.el7.x86_64</div><div class="line">--&gt; Processing Dependency: libhttp_parser.so.2()(64bit) for package: 1:nodejs-6.11.1-1.el7.x86_64</div><div class="line">--&gt; Running transaction check</div><div class="line">---&gt; Package nodejs.x86_64 1:6.11.1-1.el7 will be installed</div><div class="line">--&gt; Processing Dependency: http-parser &gt;= 2.7.0 for package: 1:nodejs-6.11.1-1.el7.x86_64</div><div class="line">--&gt; Processing Dependency: libhttp_parser.so.2()(64bit) for package: 1:nodejs-6.11.1-1.el7.x86_64</div><div class="line">---&gt; Package npm.x86_64 1:3.10.10-1.6.11.1.1.el7 will be installed</div><div class="line">--&gt; Finished Dependency Resolution</div><div class="line">Error: Package: 1:nodejs-6.11.1-1.el7.x86_64 (epel)</div><div class="line">           **Requires: libhttp_parser.so.2()(64bit)**</div><div class="line">Error: Package: 1:nodejs-6.11.1-1.el7.x86_64 (epel)</div><div class="line">           **Requires: http-parser &gt;= 2.7.0**</div><div class="line"> You could try using --skip-broken to work around the problem</div><div class="line"> You could try running: rpm -Va --nofiles --nodigest</div></pre></td></tr></table></figure>
<h3 id="对策"><a href="#对策" class="headerlink" title="对策"></a>对策</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpm -ivh https://kojipkgs.fedoraproject.org//packages/http-parser/2.7.1/3.el7/x86_64/http-parser-2.7.1-3.el7.x86_64.rpm &amp;&amp; yum -y install nodejs</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;Can&amp;apos;t install nodejs on centos7
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Nginx" scheme="http://www.nealma.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://www.nealma.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十八) 任务计划 Scheduled</title>
    <link href="http://www.nealma.com/2017/07/06/spring-boot-18-scheduled/"/>
    <id>http://www.nealma.com/2017/07/06/spring-boot-18-scheduled/</id>
    <published>2017-07-06T07:56:45.000Z</published>
    <updated>2017-09-25T02:25:37.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>工作中，我们经常会定时导出报表，或者定期检测数据库中某些状态，亦或者是提前编辑好文章做个定时发布，and so on.
</code></pre><a id="more"></a>
<h3 id="激活定时任务支持-EnableScheduling"><a href="#激活定时任务支持-EnableScheduling" class="headerlink" title="激活定时任务支持 @EnableScheduling"></a>激活定时任务支持 @EnableScheduling</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@SpringBootApplication</div><div class="line">@EnableScheduling</div><div class="line">public class Application extends SpringBootServletInitializer&#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line"></div><div class="line">        SpringApplication.run(Application.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="自定义一个Job类，每个任务计划使用-Scheduled注解"><a href="#自定义一个Job类，每个任务计划使用-Scheduled注解" class="headerlink" title="自定义一个Job类，每个任务计划使用@Scheduled注解"></a>自定义一个Job类，每个任务计划使用@Scheduled注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line">public class AIJobs &#123;</div><div class="line"></div><div class="line">    private static final Logger LOGGER = LoggerFactory.getLogger(AIJobs.class);</div><div class="line">    private static final SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;HH:mm:ss&quot;);</div><div class="line">    private static final int STIME = 1000;</div><div class="line">    private static  int DELAY_COUNT = 1;</div><div class="line">    private static  int RATE_COUNT = 1;</div><div class="line">    private static  int CRON_COUNT = 1;</div><div class="line"></div><div class="line">    @Scheduled(fixedDelay = STIME*5) //task执行结束后延迟STIME秒再执行下一次，每次总计用时: task执行时间(3)+延后时间(5)=8秒</div><div class="line">    public void fixedDelay() throws InterruptedException &#123;</div><div class="line">        Thread.sleep(3*1000);</div><div class="line">       LOGGER.debug(&quot;count &#123;&#125;, delay &#123;&#125;&quot;, DELAY_COUNT++, dateFormat.format(new Date()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Scheduled(fixedRate = STIME*2)//每隔STIME秒就执行一次，每次总计用时: 延后时间(5)=2秒（即不考虑task执行时间）</div><div class="line">    public void fixedRate() throws InterruptedException &#123;</div><div class="line">        Thread.sleep(2*1000);</div><div class="line">        LOGGER.debug(&quot;count &#123;&#125;, rate &#123;&#125;&quot;, RATE_COUNT++, dateFormat.format(new Date()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //     cron 用过Linux的crontab都知道怎么回事，他们是一样的</div><div class="line">    //     第一位，表示秒，取值[0-59]</div><div class="line">    //     第二位，表示分，取值[0-59]</div><div class="line">    //     第三位，表示小时，取值[0-23]</div><div class="line">    //     第四位，日期天/日，取值[1-31]</div><div class="line">    //     第五位，日期月份，取值[1-12]</div><div class="line">    //     第六位，周几，1:周一, 2:周二, 3:周三, 4:周四, 5:周五, 6:周六 7:周日, 1/3 周一到周三; 1#1 第一周的周一;</div><div class="line">    //     第7位，年份, 但是在这里我们只能使用前六位，Spring只支持6位字段</div><div class="line"></div><div class="line">    //    (*)星号：每秒，每分，每天，每月，每年...</div><div class="line">    //    (?)问号：问号只能出现在日期和周这两个位置，表示这个位置的值不确定。</div><div class="line">    //    (-)减号：一个范围，如“1-3”，即1,2,3</div><div class="line">    //    (,)逗号：一个散列值，如第一位“1,2,4”，则表示1s,2s,3s执行task</div><div class="line">    //    (/)斜杠：如：x/y，x是开始值，y是步长，比如在第一位（秒） 1/30就是，从1秒开始，每隔30秒，最后就是每分钟的1，31，  另：*/y，等同于0/y</div><div class="line">    //    (#) 出现在周的位置，1#1，Spring中不支持</div><div class="line"></div><div class="line">    //  0 0 3 * * ?      每天3点执行</div><div class="line">    //  0 5 3 * * ?      每天3点5分执行</div><div class="line">    //  0 5 3 ? * *      每天3点5分执行，与上面作用相同</div><div class="line">    //  0 5/10 3 * * ?   每天3点的 5分，15分，25分，35分，45分，55分这几个时间点执行</div><div class="line">    //  */1 * * * * 7    星期日的每秒，也可以 1 * * * * 7</div><div class="line">    //  0 10 3 ? * 1 #3  每个月的第三个周，周天 执行，#号只能出现在周的位置</div><div class="line">    @Scheduled(cron = &quot;0/1 * * * * 1&quot;)</div><div class="line">    public void cron()&#123;</div><div class="line">        LOGGER.debug(&quot;count &#123;&#125;, cron &#123;&#125;&quot;, CRON_COUNT++, dateFormat.format(new Date()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>cron表达式 <a href="http://cron.qqe2.com/" target="_blank" rel="external">在线生成</a></strong></p>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>～：）～～～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;工作中，我们经常会定时导出报表，或者定期检测数据库中某些状态，亦或者是提前编辑好文章做个定时发布，and so on.
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="Scheduled" scheme="http://www.nealma.com/tags/Scheduled/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十七) Async Of Spring Boot</title>
    <link href="http://www.nealma.com/2017/07/05/spring-boot-17-async/"/>
    <id>http://www.nealma.com/2017/07/05/spring-boot-17-async/</id>
    <published>2017-07-05T02:56:45.000Z</published>
    <updated>2017-09-23T04:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>同步、异步我们经常用到，在Java中我们大部分时间都是在做同步编程，因为Java天生就是同步的，
然而我们在某些场景下是需要考虑吞吐量和延迟，也就是我们经常提起的性能问题，那异步避免不了会被提起，
会给我们带来不一样的世界。
</code></pre><a id="more"></a>
<p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA<br>Build: Maven</p>
<h3 id="同步方法使用"><a href="#同步方法使用" class="headerlink" title="同步方法使用"></a>同步方法使用</h3><p>什么都不用管，你只要写相关的Class和Method就可以了，我们以一个简单的例子开启我们的异步之旅</p>
<ul>
<li><p>首先我们定义一个AsyncBean类，里面写个普通方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line">public class AsyncBean &#123;</div><div class="line"></div><div class="line">    public void syncVoid(int i)&#123;</div><div class="line">        System.out.println(&quot; async void :&quot;+i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@RunWith(SpringJUnit4ClassRunner.class)</div><div class="line">@SpringBootTest(classes = Application.class)</div><div class="line">public class AsyncTest &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private AsyncBean asyncBean;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void testSync() throws Exception &#123;</div><div class="line">        asyncBean.syncVoid(1);</div><div class="line">        asyncBean.syncVoid(2);</div><div class="line">        asyncBean.syncVoid(3);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#测试结果 Result，很明显顺序执行</div><div class="line"> async void :1</div><div class="line"> async void :2</div><div class="line"> async void :3</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="无返回-void-值异步方法使用"><a href="#无返回-void-值异步方法使用" class="headerlink" title="无返回(void)值异步方法使用"></a>无返回(void)值异步方法使用</h3><p>如果我们使用Thread也很容易实现异步，然而Spring为我们提供了更方便的@Async注解，我们又可以偷懒啦<br>：）～<br>切记要激活异步支持，否则不起作用。<br><strong>@EnableAsync</strong><br>添加到你的start-class或者测试类上。</p>
<ul>
<li><p>在AsyncBean类中，增添一个异步方法，其实只要给方法添加@Async注解就行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line">public class AsyncBean &#123;</div><div class="line"></div><div class="line"> </div><div class="line">    //异步方法</div><div class="line">    @Async</div><div class="line">    public void asyncVoid(int i)&#123;</div><div class="line">        System.out.println(&quot; async void :&quot;+i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@RunWith(SpringJUnit4ClassRunner.class)</div><div class="line">@SpringBootTest(classes = Application.class)</div><div class="line">@EnableAsync</div><div class="line">public class AsyncTest &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private AsyncBean asyncBean;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void testAsyncVoid() throws Exception &#123;</div><div class="line">        asyncBean.asyncVoid(1);</div><div class="line">        asyncBean.asyncVoid(2);</div><div class="line">        asyncBean.asyncVoid(3);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#测试结果 Result，很明显顺序不定，你可以多执行几次，观察结果。</div><div class="line"> async void :1</div><div class="line"> async void :3</div><div class="line"> async void :2</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="有返回-return-值异步方法使用"><a href="#有返回-return-值异步方法使用" class="headerlink" title="有返回(return)值异步方法使用"></a>有返回(return)值异步方法使用</h3><ul>
<li><p>在AsyncBean类中，增添一个异步方法，其实只要给方法添加@Async注解就行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line">public class AsyncBean &#123;</div><div class="line"></div><div class="line"></div><div class="line">    //异步方法 return</div><div class="line">    @Async</div><div class="line">    public String asyncReturn(int i)&#123;</div><div class="line">        System.out.println(&quot; async return :&quot;+i);</div><div class="line">        return &quot;async return&quot;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@RunWith(SpringJUnit4ClassRunner.class)</div><div class="line">@SpringBootTest(classes = Application.class)</div><div class="line">public class AsyncTest &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private AsyncBean asyncBean;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void testAsyncReturn() throws Exception &#123;</div><div class="line">        System.out.println(asyncBean.asyncReturn(1));</div><div class="line">        System.out.println(asyncBean.asyncReturn(2));</div><div class="line">        System.out.println(asyncBean.asyncReturn(3));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#测试结果 Result，很明显顺序不定。然而输出方法返回值的时候都是null，可以考虑下怎么接收返回值。</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line"> async return :3</div><div class="line"> async return :1</div><div class="line"> async return :2</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="如何接收异步方法的返回值呢？使用Future和AsyncResult、CompleteFuture来接收。"><a href="#如何接收异步方法的返回值呢？使用Future和AsyncResult、CompleteFuture来接收。" class="headerlink" title="如何接收异步方法的返回值呢？使用Future和AsyncResult、CompleteFuture来接收。"></a>如何接收异步方法的返回值呢？使用Future和AsyncResult、CompleteFuture来接收。</h3><ul>
<li><p>AsyncResult、CompleteFuture</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line">public class AsyncBean &#123;</div><div class="line"></div><div class="line">    @Async</div><div class="line">    public Future&lt;String&gt; asyncReturnFuture(int i)&#123;</div><div class="line">        try &#123;</div><div class="line">            i = i * 2;</div><div class="line">            Thread.sleep(1000);</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        return new AsyncResult&lt;&gt;(&quot; async return :&quot;+i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Async</div><div class="line">    public CompletableFuture&lt;String&gt; asyncReturnCompletableFuture(int i)&#123;</div><div class="line">        try &#123;</div><div class="line">            i = i * 2;</div><div class="line">            Thread.sleep(1000);</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        return CompletableFuture.completedFuture(&quot;async return : &quot; + i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@RunWith(SpringJUnit4ClassRunner.class)</div><div class="line">@SpringBootTest(classes = Application.class)</div><div class="line">public class AsyncTest &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private AsyncBean asyncBean;</div><div class="line">    </div><div class="line">    @Test</div><div class="line">    public void testAsyncReturnFuture() throws Exception &#123;</div><div class="line">        long start = System.currentTimeMillis();</div><div class="line">        Future&lt;String&gt; future1 = asyncBean.asyncReturnFuture(1);</div><div class="line">        Future&lt;String&gt; future2 = asyncBean.asyncReturnFuture(2);</div><div class="line">        Future&lt;String&gt; future3 = asyncBean.asyncReturnFuture(3);</div><div class="line">        System.out.println(&quot;Elapsed Time : &quot; + (System.currentTimeMillis() - start));</div><div class="line">        System.out.println(future2.get());//it block until future2 is done.</div><div class="line">        System.out.println(future1.get());</div><div class="line">        System.out.println(future3.get());</div><div class="line">        System.out.println(&quot;Elapsed Time : &quot; + (System.currentTimeMillis() - start));</div><div class="line">    &#125;</div><div class="line">    @Test</div><div class="line">    public void testAsyncReturnCompleteFuture() throws Exception &#123;</div><div class="line">        long start = System.currentTimeMillis();</div><div class="line">        CompletableFuture&lt;String&gt; future1 = asyncBean.asyncReturnCompletableFuture(1);</div><div class="line">        CompletableFuture&lt;String&gt; future2 = asyncBean.asyncReturnCompletableFuture(2);</div><div class="line">        CompletableFuture&lt;String&gt; future3 = asyncBean.asyncReturnCompletableFuture(3);</div><div class="line">        CompletableFuture.allOf(future1, future2, future3).join();//it block until all future is done.</div><div class="line">        System.out.println(&quot;Elapsed Time : &quot; + (System.currentTimeMillis() - start));</div><div class="line">        System.out.println(future2.get());</div><div class="line">        System.out.println(future1.get());</div><div class="line">        System.out.println(future3.get());</div><div class="line">        System.out.println(&quot;Elapsed Time : &quot; + (System.currentTimeMillis() - start));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#测试结果可以看出#1中三个task几乎没有消耗时间，</div><div class="line">#而#2中使用CompletableFuture.allOf(future1, future2, future3).join()，就是要等待所有task完成在往下运行。</div><div class="line"></div><div class="line">#1 testAsyncReturnFuture</div><div class="line">Elapsed Time : 6</div><div class="line"> async return :4</div><div class="line"> async return :2</div><div class="line"> async return :6</div><div class="line">Elapsed Time : 1014</div><div class="line"></div><div class="line">#2 testAsyncReturnCompleteFuture</div><div class="line">Elapsed Time : 1016</div><div class="line">async return : 4</div><div class="line">async return : 2</div><div class="line">async return : 6</div><div class="line">Elapsed Time : 1017</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>～：）～～～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;同步、异步我们经常用到，在Java中我们大部分时间都是在做同步编程，因为Java天生就是同步的，
然而我们在某些场景下是需要考虑吞吐量和延迟，也就是我们经常提起的性能问题，那异步避免不了会被提起，
会给我们带来不一样的世界。
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="Async" scheme="http://www.nealma.com/tags/Async/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十六) WebSocket Base Of Spring Boot 鉴权 2</title>
    <link href="http://www.nealma.com/2017/07/04/spring-boot-16-websocket2/"/>
    <id>http://www.nealma.com/2017/07/04/spring-boot-16-websocket2/</id>
    <published>2017-07-04T03:56:45.000Z</published>
    <updated>2017-11-20T02:50:46.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>普通用户在发送消息和互动的过程中，大部分情况下是需要授权和认证的，
也就是需要使用用户名和密码进行登录，验证成功才可以发送消息。那如何给websocket做鉴权呢？
</code></pre><a id="more"></a>
<p>—-主要是重写ChannelInterceptorAdapter—-</p>
<h3 id="继承上一篇文章，这里我们只要给websocket加个拦截器就可以了"><a href="#继承上一篇文章，这里我们只要给websocket加个拦截器就可以了" class="headerlink" title="继承上一篇文章，这里我们只要给websocket加个拦截器就可以了"></a>继承上一篇文章，这里我们只要给websocket加个拦截器就可以了</h3><p>在WebSocketConfig.java文件里增加配置，即增加拦截器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">    public void configureClientInboundChannel(final ChannelRegistration registration) &#123;</div><div class="line">        registration.setInterceptors(new AuthChannelInterceptorAdapter());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="拦截器的内容"><a href="#拦截器的内容" class="headerlink" title="拦截器的内容"></a>拦截器的内容</h3><p>AuthChannelInterceptorAdapter.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public class AuthChannelInterceptorAdapter extends ChannelInterceptorAdapter &#123;</div><div class="line">    private static final Logger LOGGER = LoggerFactory.getLogger(AuthChannelInterceptorAdapter.class);</div><div class="line">    private static final String USERNAME_HEADER = &quot;login&quot;;</div><div class="line">    private static final String PASSWORD_HEADER = &quot;passcode&quot;;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Message&lt;?&gt; preSend(final Message&lt;?&gt; message, final MessageChannel channel) throws AuthenticationException &#123;</div><div class="line">        final StompHeaderAccessor accessor = MessageHeaderAccessor.getAccessor(message, StompHeaderAccessor.class);</div><div class="line">        LOGGER.debug(&quot;preSend : message &#123;&#125;, channel &#123;&#125;&quot;, message, channel);</div><div class="line">        if (StompCommand.CONNECT == accessor.getCommand()) &#123;</div><div class="line">            final String username = accessor.getFirstNativeHeader(USERNAME_HEADER);</div><div class="line">            final String password = accessor.getFirstNativeHeader(PASSWORD_HEADER);</div><div class="line">            LOGGER.debug(&quot;username : &#123;&#125;&quot;, username);</div><div class="line">            LOGGER.debug(&quot;password : &#123;&#125;&quot;, password);</div><div class="line"></div><div class="line">            final UsernamePasswordAuthenticationToken user = this.getAuthenticatedOrFail(username, password);</div><div class="line"></div><div class="line">            accessor.setUser(user);</div><div class="line">        &#125;</div><div class="line">        return message;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public UsernamePasswordAuthenticationToken getAuthenticatedOrFail(final String  username, final String password) throws AuthenticationException &#123;</div><div class="line">        if (username == null || username.trim().length() == 0) &#123;</div><div class="line">            throw new AuthenticationCredentialsNotFoundException(&quot;Username was null or empty.&quot;);</div><div class="line">        &#125;</div><div class="line">        if (password == null || password.trim().length() == 0) &#123;</div><div class="line">            throw new AuthenticationCredentialsNotFoundException(&quot;Password was null or empty.&quot;);</div><div class="line">        &#125;</div><div class="line">        // Add your own logic for retrieving user in fetchUserFromDb()</div><div class="line">        if (fetchUserFromDb(username, password) == null) &#123;</div><div class="line">            throw new BadCredentialsException(&quot;Bad credentials for user &quot; + username);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // null credentials, we do not pass the password along to prevent security flaw</div><div class="line">        return new UsernamePasswordAuthenticationToken(</div><div class="line">                username,</div><div class="line">                null,</div><div class="line">                Collections.singleton((GrantedAuthority) () -&gt; &quot;USER&quot;)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private Object fetchUserFromDb(String username, String password) &#123;</div><div class="line">        return new Object();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="重要方法-preSend"><a href="#重要方法-preSend" class="headerlink" title="重要方法 preSend"></a>重要方法 preSend</h3><p>  在这里可以根据header的内容，做用户验证<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">final String username = accessor.getFirstNativeHeader(USERNAME_HEADER);</div><div class="line">final String password = accessor.getFirstNativeHeader(PASSWORD_HEADER);</div></pre></td></tr></table></figure></p>
<p>客户端(js)增加header的参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">stompClient.connect(&#123; login: &apos;nealma&apos;, passcode: &apos;passcode&apos; &#125;, function (frame) &#123;    </div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>。
 ～：）～～～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;普通用户在发送消息和互动的过程中，大部分情况下是需要授权和认证的，
也就是需要使用用户名和密码进行登录，验证成功才可以发送消息。那如何给websocket做鉴权呢？
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="WebSocket" scheme="http://www.nealma.com/tags/WebSocket/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十六) WebSocket Base Of Spring Boot 1</title>
    <link href="http://www.nealma.com/2017/07/04/spring-boot-16-websocket/"/>
    <id>http://www.nealma.com/2017/07/04/spring-boot-16-websocket/</id>
    <published>2017-07-04T02:56:45.000Z</published>
    <updated>2017-10-23T07:24:09.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>websocket是一个持久化的协议，实现了浏览器与服务器的全双工通信。
我们很轻松的就可以将服务器端的内容推送给浏览器。
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>websocket是一个持久化的协议，实现了浏览器与服务器的全双工通信。
我们很轻松的就可以将服务器端的内容推送给浏览器。这里需要借助STOMP协议，
即Streaming Text Oriented Messaging Protocol.
</code></pre><p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA<br>Build: Maven</p>
<h3 id="加入依赖"><a href="#加入依赖" class="headerlink" title="加入依赖"></a>加入依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#Server Side</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"></div><div class="line">#Browser Side</div><div class="line"></div><div class="line">sockjs.js</div><div class="line">stomp.js</div></pre></td></tr></table></figure>
<h3 id="WebSocket-Configuration"><a href="#WebSocket-Configuration" class="headerlink" title="WebSocket Configuration"></a>WebSocket Configuration</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">@EnableWebSocketMessageBroker</div><div class="line">public class WebSocketConfig extends AbstractWebSocketMessageBrokerConfigurer&#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void registerStompEndpoints(StompEndpointRegistry registry) &#123;</div><div class="line">        registry.addEndpoint(&quot;/web-socket&quot;).withSockJS();//客户端js调用，new SockJS(&quot;/web-socket&quot;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void configureMessageBroker(MessageBrokerRegistry config) &#123;</div><div class="line">        config.setApplicationDestinationPrefixes(&quot;/app&quot;);//就是你的客户端请求的路径前缀</div><div class="line">        config.enableSimpleBroker(&quot;/topic&quot;);//可以设置多个</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Controller-对外输出接口"><a href="#Controller-对外输出接口" class="headerlink" title="Controller 对外输出接口"></a>Controller 对外输出接口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@RestController</div><div class="line">public class WebSocketController extends BaseController &#123;</div><div class="line"></div><div class="line">    @MessageMapping(&quot;/greeting&quot;)//客户端请求路径，不要忘记客户端要加上前缀“/app”,即“/app/greeting”</div><div class="line">    @SendTo(&quot;/topic/hi&quot;)//给订阅这个路径的所有客户端(Browser)发送数据</div><div class="line">    public String handle(String greeting) &#123;</div><div class="line">        LOGGER.error(TimeUtils.getCurrentDate());</div><div class="line">        return &quot;[&quot; + TimeUtils.getCurrentDatetime() + &quot;: &quot; + greeting;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="客户端（Browser）"><a href="#客户端（Browser）" class="headerlink" title="客户端（Browser）"></a>客户端（Browser）</h3><p>–引入组件–</p>
<script src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.js"></script>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#connect</div><div class="line">var socket = new SockJS(&apos;/web-socket&apos;);</div><div class="line">var stompClient = Stomp.over(socket);</div><div class="line">stompClient.connect(&#123;&#125;, function (frame) &#123;</div><div class="line">    console.log(&apos;Connected:&apos; + frame);</div><div class="line">    stompClient.subscribe(&apos;/topic/hi&apos;, function (message) &#123;</div><div class="line">        console.log(&apos;message :&apos; + message.body);</div><div class="line">        console.log(&apos;header : &apos; + message.headers[&apos;header1&apos;]);</div><div class="line">    &#125;)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">#request（send message）</div><div class="line">stompClient.send(&quot;/app/greeting&quot;, &#123; header1: &apos;Header 1&apos; &#125;, JSON.stringify(&#123;&apos;greeting&apos;: name&#125;));</div><div class="line"></div><div class="line">#disconnect</div><div class="line">stompClient.disconnect();</div></pre></td></tr></table></figure>
<h3 id="App-behind-Nnginx"><a href="#App-behind-Nnginx" class="headerlink" title="App behind Nnginx"></a>App behind Nnginx</h3><p>会发生如下这个问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Error during WebSocket handshake: Unexpected response code: 400 ／ 403</div></pre></td></tr></table></figure></p>
<p>这个时候，你就要配置你的Nginx了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">proxy_pass http://localhost:8080;</div><div class="line">proxy_http_version 1.1;</div><div class="line">proxy_set_header Upgrade $http_upgrade;</div><div class="line">proxy_set_header Connection &quot;upgrade&quot;;</div><div class="line">proxy_set_header Host $host;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="当你的应用变为HTTPs时，可能会报”wss-403”的异常，在原来基础上作如下变更"><a href="#当你的应用变为HTTPs时，可能会报”wss-403”的异常，在原来基础上作如下变更" class="headerlink" title="当你的应用变为HTTPs时，可能会报”wss 403”的异常，在原来基础上作如下变更"></a>当你的应用变为HTTPs时，可能会报”wss 403”的异常，在原来基础上作如下变更</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#setAllowedOrigins(&quot;*&quot;)</div><div class="line">registry.addEndpoint(&quot;/web-socket&quot;).setAllowedOrigins(&quot;*&quot;).withSockJS();</div></pre></td></tr></table></figure>
<h3 id="如果有需要指定发送消息的需求，可以使用如下方式"><a href="#如果有需要指定发送消息的需求，可以使用如下方式" class="headerlink" title="如果有需要指定发送消息的需求，可以使用如下方式"></a>如果有需要指定发送消息的需求，可以使用如下方式</h3><ul>
<li>org.springframework.messaging.simp.SimpMessagingTemplate里面有好多方法，最常用的<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">messagingTemplate.convertAndSend(&quot;/topic/notify/&quot;+roomId, message);</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>测试的时候，当你打开n个浏览器窗口，你会发现，订阅了&apos;/topic/hi&apos;的客户端窗口，都会收到信息。
 ～：）～～～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;websocket是一个持久化的协议，实现了浏览器与服务器的全双工通信。
我们很轻松的就可以将服务器端的内容推送给浏览器。
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="WebSocket" scheme="http://www.nealma.com/tags/WebSocket/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud | 服务注册与发现</title>
    <link href="http://www.nealma.com/2017/07/02/spring-cloud-2-euraka/"/>
    <id>http://www.nealma.com/2017/07/02/spring-cloud-2-euraka/</id>
    <published>2017-07-02T03:46:45.000Z</published>
    <updated>2017-11-30T10:08:22.413Z</updated>
    
    <content type="html"><![CDATA[<p>Spring Cloud为我构建分布式微服务系统提供了一站式的解决方案，其中服务注册与发现只是整个系统的一个模块，<br>是由eureka来承担，下面我们来看看如何使用吧</p>
<a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Spring Cloud为我构建分布式微服务系统提供了一站式的解决方案，其中服务注册与发现只是整个系统的一个模块，<br>是由eureka来承担，下面我们来看看如何使用吧</p>
<p>用起来so easy, 普通的Spring Boot项目，使用@EnableEurekaServer注解，就启动了<br>一个服务注册中心，是不是很容易。当然了，避免不了添加以下依赖</p>
<p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA 2016.2<br>Build: Maven</p>
<h3 id="首先是eureka-server端-添加POM依赖"><a href="#首先是eureka-server端-添加POM依赖" class="headerlink" title="首先是eureka server端 添加POM依赖"></a>首先是eureka server端 添加POM依赖</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;dependencyManagement&gt;</div><div class="line">    &lt;dependencies&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;Dalston.SR1&lt;/version&gt;</div><div class="line">            &lt;type&gt;pom&lt;/type&gt;</div><div class="line">            &lt;scope&gt;import&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">    &lt;/dependencies&gt;</div><div class="line">&lt;/dependencyManagement&gt;</div><div class="line"></div><div class="line">&lt;dependencies&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-cloud-eureka-server&lt;/artifactId&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">&lt;/dependencies&gt;</div></pre></td></tr></table></figure>
<p>application.yml配置如下(单机模式)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">server:</div><div class="line">  port: 8082</div><div class="line">  tomcat:</div><div class="line">    uri-encoding: utf-8</div><div class="line">spring:</div><div class="line">  application:</div><div class="line">    name: eureka-server</div><div class="line">eureka:</div><div class="line">  instance:</div><div class="line">    appname: $&#123;spring.application.name&#125;</div><div class="line">  client:</div><div class="line">    registerWithEureka: false #是否将自身注册</div><div class="line">    fetchRegistry: false</div><div class="line">    serviceUrl:</div><div class="line">      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</div></pre></td></tr></table></figure></p>
<h3 id="在入口类加上注解-EnableEurekaServer，开启服务发现与注册中心"><a href="#在入口类加上注解-EnableEurekaServer，开启服务发现与注册中心" class="headerlink" title="在入口类加上注解@EnableEurekaServer，开启服务发现与注册中心"></a>在入口类加上注解@EnableEurekaServer，开启服务发现与注册中心</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@SpringBootApplication</div><div class="line">@EnableEurekaServer</div><div class="line">public class EurekaServerApplication &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        SpringApplication.run(ConfigServerApplication.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="其次是eureka-client端-添加POM依赖"><a href="#其次是eureka-client端-添加POM依赖" class="headerlink" title="其次是eureka client端 添加POM依赖"></a>其次是eureka client端 添加POM依赖</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;dependencyManagement&gt;</div><div class="line">    &lt;dependencies&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;Dalston.SR1&lt;/version&gt;</div><div class="line">            &lt;type&gt;pom&lt;/type&gt;</div><div class="line">            &lt;scope&gt;import&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">    &lt;/dependencies&gt;</div><div class="line">&lt;/dependencyManagement&gt;</div><div class="line"></div><div class="line">&lt;dependencies&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">&lt;/dependencies&gt;</div></pre></td></tr></table></figure>
<h3 id="在入口类加上注解-EnableEurekaClient"><a href="#在入口类加上注解-EnableEurekaClient" class="headerlink" title="在入口类加上注解@EnableEurekaClient"></a>在入口类加上注解@EnableEurekaClient</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@SpringBootApplication</div><div class="line">@EnableEurekaClient</div><div class="line">public class EurekaClientApplication &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        SpringApplication.run(ConfigServerApplication.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>application.yml增加eureka的配置内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">eureka:</div><div class="line">  client:</div><div class="line">    service-url:</div><div class="line">      defaultZone: http://localhost:8082/eureka/</div><div class="line">  instance:</div><div class="line">    appname: $&#123;spring.application.name&#125;</div></pre></td></tr></table></figure></p>
<h3 id="EnableDiscoveryClient-和-EnableEurekaClient-区别"><a href="#EnableDiscoveryClient-和-EnableEurekaClient-区别" class="headerlink" title="EnableDiscoveryClient 和 EnableEurekaClient 区别"></a>EnableDiscoveryClient 和 EnableEurekaClient 区别</h3><p>SpringCLoud中的“Discovery Service”有多种实现，比如：eureka, consul, zookeeper。</p>
<p>1，@EnableDiscoveryClient注解是基于spring-cloud-commons依赖<br>2，@EnableEurekaClient注解是基于spring-cloud-netflix依赖，只能为eureka作用；</p>
<p>如果你添加了eureka，则它们的作用是一样的。</p>
<h3 id="客户端查看已注册的instance"><a href="#客户端查看已注册的instance" class="headerlink" title="客户端查看已注册的instance"></a>客户端查看已注册的instance</h3><p>在客户段创建如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">@RestController</div><div class="line">public class EurekaClientController &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private DiscoveryClient discoveryClient;</div><div class="line"></div><div class="line">    @RequestMapping(value = &quot;/admin/eureka/client/group_name1&quot;)</div><div class="line">    public String hi()&#123;</div><div class="line"></div><div class="line">        for( String s :  discoveryClient.getServices())&#123;</div><div class="line">            System.out.println(&quot;services &quot; + s);</div><div class="line">            List&lt;ServiceInstance&gt; serviceInstances =  discoveryClient.getInstances(s);</div><div class="line">            for(ServiceInstance si : serviceInstances)&#123;</div><div class="line">                System.out.println(&quot;    services:&quot; + s + &quot;:getHost()=&quot; + si.getHost());</div><div class="line">                System.out.println(&quot;    services:&quot; + s + &quot;:getPort()=&quot; + si.getPort());</div><div class="line">                System.out.println(&quot;    services:&quot; + s + &quot;:getServiceId()=&quot; + si.getServiceId());</div><div class="line">                System.out.println(&quot;    services:&quot; + s + &quot;:getUri()=&quot; + si.getUri());</div><div class="line">                System.out.println(&quot;    services:&quot; + s + &quot;:getMetadata()=&quot; + si.getMetadata());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        return &quot;hi, :)~&quot;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ip、主机名问题"><a href="#ip、主机名问题" class="headerlink" title="ip、主机名问题"></a>ip、主机名问题</h3><pre><code>在实际工作中，我们需要发现的服务实例为http[s]://ip:port的形式，但是eureka服务端默认
使用的是主机域名：port的格式，那是不是有办法变更呢？
那当然可以了，so easy.
只需在服务端 添加如下即可
</code></pre><pre><code>eureka:
 instance:
   prefer-ip-address: true
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Spring Cloud为我构建分布式微服务系统提供了一站式的解决方案，其中服务注册与发现只是整个系统的一个模块，&lt;br&gt;是由eureka来承担，下面我们来看看如何使用吧&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud" scheme="http://www.nealma.com/categories/Spring-Cloud/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring Cloud" scheme="http://www.nealma.com/tags/Spring-Cloud/"/>
    
      <category term="Spring-Cloud" scheme="http://www.nealma.com/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud | 配置服务 2</title>
    <link href="http://www.nealma.com/2017/07/01/spring-cloud-1-config2/"/>
    <id>http://www.nealma.com/2017/07/01/spring-cloud-1-config2/</id>
    <published>2017-07-01T03:46:45.000Z</published>
    <updated>2017-11-20T07:48:08.412Z</updated>
    
    <content type="html"><![CDATA[<p>上文我们了解了Config Server的基本使用，以及手动更新具体的服务，<br>但是现在的应用都是分布式，微服务会随着App的增多，管理会更难，更辛苦。怎么解放我们<br>的运维伙伴呢，我们慢慢来探索吧。</p>
<a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>git的方式对于我们程序员来说，非常熟悉和了解，易于上手。对于版本控制更是拿手，下面我们来看看<br>如何才能让每个App自己来感知和自动更新配置信息。</p>
<p>Spring Cloud为我们送来了Spring Cloud Bus消息总线，让每个App自动感知和更新配置信息，<br>这里需要借助RabbitMQ、Redis、Kafka等第三方工具。</p>
<p>接下来，让我们以rabbitMQ为例，看看如何使用吧。</p>
<p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA 2016.2<br>Build: Maven</p>
<h3 id="安装rabbitMQ"><a href="#安装rabbitMQ" class="headerlink" title="安装rabbitMQ"></a>安装rabbitMQ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">brew install rabbitmq</div><div class="line"></div><div class="line">#run</div><div class="line">brew services start rebbitmq</div><div class="line"></div><div class="line">#通过浏览器查看信息</div><div class="line">http://localhost:15672</div><div class="line"></div><div class="line">#初始化时只有guest用户，可以在操控台创建一个新用户，切记点击新用户，为他授权，否则访问不了</div></pre></td></tr></table></figure>
<p>注意浏览器里和配置文件里使用的是不同的端口，分别是：15672、5672</p>
<h3 id="继前文，ConfigServer端我们需要增加依赖和配置信息"><a href="#继前文，ConfigServer端我们需要增加依赖和配置信息" class="headerlink" title="继前文，ConfigServer端我们需要增加依赖和配置信息"></a>继前文，ConfigServer端我们需要增加依赖和配置信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">  &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">spring:</div><div class="line">  rabbitmq:</div><div class="line">    host: localhost</div><div class="line">    port: 5672</div><div class="line">    username: neal</div><div class="line">    password: neal</div></pre></td></tr></table></figure>
<h3 id="根据上一篇文章，改造client端"><a href="#根据上一篇文章，改造client端" class="headerlink" title="根据上一篇文章，改造client端"></a>根据上一篇文章，改造client端</h3><ul>
<li>首先引入依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;dependencies&gt;</div><div class="line">    &lt;!-- 增加bus-amqp依赖 --&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">&lt;/dependencies&gt;</div></pre></td></tr></table></figure>
<ul>
<li>配置文件增加rabbitmq内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">spring:</div><div class="line"> rabbitmq:</div><div class="line">   host: localhost</div><div class="line">   port: 5672</div><div class="line">   username: neal</div><div class="line">   password: neal</div></pre></td></tr></table></figure>
<h3 id="手动更新ConfigServer服务器（刷新方式）"><a href="#手动更新ConfigServer服务器（刷新方式）" class="headerlink" title="手动更新ConfigServer服务器（刷新方式）"></a>手动更新ConfigServer服务器（刷新方式）</h3><ul>
<li>全部更新</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -v -XPOST &apos;http://localhost:8080/bus/refresh&apos;</div></pre></td></tr></table></figure>
<p>这个时候，其他客户端也会同步自动更新</p>
<ul>
<li>只更新指定客户端,destination=appName:port为要刷新的服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -v -XPOST &apos;http://localhost:8080/bus/refresh?destination=appName:port&apos;</div></pre></td></tr></table></figure>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>好了，这下不需要手动刷新每一台服务了...
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;上文我们了解了Config Server的基本使用，以及手动更新具体的服务，&lt;br&gt;但是现在的应用都是分布式，微服务会随着App的增多，管理会更难，更辛苦。怎么解放我们&lt;br&gt;的运维伙伴呢，我们慢慢来探索吧。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud" scheme="http://www.nealma.com/categories/Spring-Cloud/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring Cloud" scheme="http://www.nealma.com/tags/Spring-Cloud/"/>
    
      <category term="Spring-Cloud" scheme="http://www.nealma.com/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud | 配置服务 1</title>
    <link href="http://www.nealma.com/2017/06/30/spring-cloud-1-config/"/>
    <id>http://www.nealma.com/2017/06/30/spring-cloud-1-config/</id>
    <published>2017-06-30T03:46:45.000Z</published>
    <updated>2017-09-12T06:37:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>Spring Boot提供了application.[properties|yml]文件来提供默认配置，<br>简化了原来冗余的配置，但是随着环境和应用服务的增多，很难管理分散在各个项目中的配置，<br>但是，现在Spring Cloud 提供了 Config Server, 使其在分布式系统开发中输出外部配置的能力。<br>通过 Config Server，我们可以集中存储所有应用的配置文件</p>
<a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Spring Boot提供了application.[properties|yml]文件来提供默认配置，<br>简化了原来冗余的配置，但是随着环境和应用服务的增多，很难管理分散在各个项目中的配置，<br>但是，现在Spring Cloud 提供了 Config Server, 使其在分布式系统开发中输出外部配置的能力。<br>通过 Config Server，我们可以集中存储所有应用的配置文件</p>
<p>Config Server 支持git或者在文件系统中放置配置文件，<br>可以通过以下格式来区分不同应用的不同配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/&#123;application&#125;/&#123;profile&#125;/&#123;label&#125;</div><div class="line">/&#123;application&#125;-&#123;profile&#125;.yml</div><div class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</div><div class="line">/&#123;application&#125;-&#123;profile&#125;.properties</div><div class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</div></pre></td></tr></table></figure></p>
<p>Spring Cloud 提供了注解@EnableConfigServer来启用配置服务</p>
<p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA 2016.2<br>Build: Maven</p>
<h3 id="添加POM依赖"><a href="#添加POM依赖" class="headerlink" title="添加POM依赖"></a>添加POM依赖</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;dependencyManagement&gt;</div><div class="line">    &lt;dependencies&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;Dalston.SR1&lt;/version&gt;</div><div class="line">            &lt;type&gt;pom&lt;/type&gt;</div><div class="line">            &lt;scope&gt;import&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">    &lt;/dependencies&gt;</div><div class="line">&lt;/dependencyManagement&gt;</div><div class="line"></div><div class="line">&lt;dependencies&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">&lt;/dependencies&gt;</div></pre></td></tr></table></figure>
<p>如果项目报依赖找不到，执行下面的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn -U clean install</div></pre></td></tr></table></figure></p>
<h3 id="在入口类加上注解-EnableConfigServer，开启配置服务"><a href="#在入口类加上注解-EnableConfigServer，开启配置服务" class="headerlink" title="在入口类加上注解@EnableConfigServer，开启配置服务"></a>在入口类加上注解@EnableConfigServer，开启配置服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@SpringBootApplication</div><div class="line">@EnableConfigServer</div><div class="line">public class ConfigServerApplication &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        SpringApplication.run(ConfigServerApplication.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="git方式的配置中心使用"><a href="#git方式的配置中心使用" class="headerlink" title="git方式的配置中心使用"></a>git方式的配置中心使用</h3><pre><code>Config Server使用git来配置，其实原理就是配置服务获取远程git的文件，存在app的本地host中
相关配置如下：
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cloud:</div><div class="line">    config:</div><div class="line">      server:</div><div class="line">        git:</div><div class="line">          uri: git@git.oschina.net:x/y.git</div><div class="line">          clone-on-start: true</div><div class="line">          strict-host-key-checking: false</div></pre></td></tr></table></figure>
<p>git@git.oschina.net:x/y.git为配置中心的repo的配置文件的存储位置，<br>我们创建一个配置文件：application_name-env_name.yml<br>eg. configserver-dev.yml</p>
<p>启动项目后，我们可以通过如下url来访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">http://localhost:8080/configserver/dev/master</div><div class="line">http://localhost:8080/configserver-dev.yml</div><div class="line">http://localhost:8080/master/configserver-dev.yml</div><div class="line">#json格式</div><div class="line">http://localhost:8080/master/configserver-dev.json</div><div class="line">#properties格式</div><div class="line">http://localhost:8080/master/configserver-dev.properties</div></pre></td></tr></table></figure>
<h3 id="这样很容易就能访问到配置信息，很恐怖，那怎么办呢？别担心，so-easy"><a href="#这样很容易就能访问到配置信息，很恐怖，那怎么办呢？别担心，so-easy" class="headerlink" title="这样很容易就能访问到配置信息，很恐怖，那怎么办呢？别担心，so easy."></a>这样很容易就能访问到配置信息，很恐怖，那怎么办呢？别担心，so easy.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">security:</div><div class="line">  user: </div><div class="line">    name: abc</div><div class="line">    password: xyz</div></pre></td></tr></table></figure>
<p>看你还能访问。</p>
<p>如果想要你的用户密码起作用，还得引入下面的依赖，你懂的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</div><div class="line">&lt;/dependency</div></pre></td></tr></table></figure></p>
<h3 id="client端如何使用"><a href="#client端如何使用" class="headerlink" title="client端如何使用"></a>client端如何使用</h3><ul>
<li>首先引入依赖<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;dependencyManagement&gt;</div><div class="line">    &lt;dependencies&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;Dalston.SR1&lt;/version&gt;</div><div class="line">            &lt;type&gt;pom&lt;/type&gt;</div><div class="line">            &lt;scope&gt;import&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">    &lt;/dependencies&gt;</div><div class="line">&lt;/dependencyManagement&gt;</div><div class="line"></div><div class="line">&lt;dependencies&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-cloud-config-client&lt;/artifactId&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">&lt;/dependencies&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="增加bootstraps-yml文件-如果开启了security请注意username和password"><a href="#增加bootstraps-yml文件-如果开启了security请注意username和password" class="headerlink" title="增加bootstraps.yml文件, 如果开启了security请注意username和password"></a>增加bootstraps.yml文件, 如果开启了security请注意username和password</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">spring:</div><div class="line"> application:</div><div class="line">   name: your app name</div><div class="line"> cloud:</div><div class="line">   config:</div><div class="line">     uri: http://localhost:8088 //你的 config server 服务</div><div class="line">     profile: dev</div><div class="line">     username: abc</div><div class="line">     password: xyz</div></pre></td></tr></table></figure>
<h3 id="手动更新"><a href="#手动更新" class="headerlink" title="手动更新"></a>手动更新</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -v -XPOST &apos;http://localhost:8080/refresh&apos;</div></pre></td></tr></table></figure>
<p>这个时候，你可能会遇到这个问题，401权限问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt; X-Frame-Options: DENY</div><div class="line">&lt; Strict-Transport-Security: max-age=31536000 ; includeSubDomains</div><div class="line">&lt; WWW-Authenticate: Basic realm=&quot;Spring&quot;</div><div class="line">&lt; Location: http://localhost:8080/error/401.html</div></pre></td></tr></table></figure></p>
<p>这是因为actuator中POST方法相关的接口是受限的，如果你想免去鉴权，可以在配置文件中添加如下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">management:</div><div class="line">  security:</div><div class="line">    enabled: false</div><div class="line">`</div></pre></td></tr></table></figure></p>
<p>这样一旦配置变更，客户端也不需要重启服务，可以动态更新了，然而还是需要手动来做/refresh的操作。</p>
<h3 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h3><pre><code>通过以上配置，我们还不能动态更新配置，你会发现，我的git中文件有更新，
但是你的app不会及时更新，那需要额外的工作，且听下回分解 :)~
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Spring Boot提供了application.[properties|yml]文件来提供默认配置，&lt;br&gt;简化了原来冗余的配置，但是随着环境和应用服务的增多，很难管理分散在各个项目中的配置，&lt;br&gt;但是，现在Spring Cloud 提供了 Config Server, 使其在分布式系统开发中输出外部配置的能力。&lt;br&gt;通过 Config Server，我们可以集中存储所有应用的配置文件&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud" scheme="http://www.nealma.com/categories/Spring-Cloud/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring Cloud" scheme="http://www.nealma.com/tags/Spring-Cloud/"/>
    
      <category term="Spring-Cloud" scheme="http://www.nealma.com/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript | jQuery 自定义插件</title>
    <link href="http://www.nealma.com/2017/06/24/js-1-jquery-extend/"/>
    <id>http://www.nealma.com/2017/06/24/js-1-jquery-extend/</id>
    <published>2017-06-24T03:46:45.000Z</published>
    <updated>2017-07-01T04:02:31.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>以前写过javascript，但都是临时更改，没怎么太研究怎么去写好，怎么去封装，还有jQuery，都是拿来即用，
根本就没想过去写插件，主要吧，都是作后端的内容，很少写前端代码。其实写写前端挺有意思的，顺便心血来潮，
整个jQuery插件玩玩：）～
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>以前写过javascript，但都是临时更改，没怎么太研究怎么去写好，怎么去封装，还有JQuery，都是拿来即用，
根本就没想过去写插件，主要吧，都是做后端的内容，很少写前端代码。其实写写前端挺有意思的，顺便心血来潮，
整个JQuery插件玩玩：）～

* $.fn.extend 当然这种方式只适用实例范围, 例如：$([class name | tag | et..]).hi(),可以调用
</code></pre><h3 id="无参插件"><a href="#无参插件" class="headerlink" title="无参插件"></a>无参插件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$.fn.extend(&#123;</div><div class="line">	hi: function () &#123;</div><div class="line">	  alert(&quot;hello world.&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>切记：为了不和其他插件对共享$这个符号的冲突，尽量用下面这个包起来，妥妥的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(function($)&#123;</div><div class="line">	</div><div class="line">&#125;)(jQuery);</div></pre></td></tr></table></figure>
<p>调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(&quot;#id&quot;).hi();</div></pre></td></tr></table></figure></p>
<h3 id="有残参插件，当然这种方式只适用实例范围-例如：-class-name-tag-et-hi-可以调用"><a href="#有残参插件，当然这种方式只适用实例范围-例如：-class-name-tag-et-hi-可以调用" class="headerlink" title="有残参插件，当然这种方式只适用实例范围, 例如：$([class name | tag | et..]).hi(),可以调用"></a>有残参插件，当然这种方式只适用实例范围, 例如：$([class name | tag | et..]).hi(),可以调用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$.fn.extend(&#123;</div><div class="line">	hi: function (options) &#123;</div><div class="line">	  var defaults=&#123;</div><div class="line">	      background:&apos;red&apos;</div><div class="line">	  &#125;;</div><div class="line">	  var opts = $.extend(defaults,options);//合并两个对象为一个，类似于java的copyProperties(original, target)</div><div class="line">	  $(this).css(&quot;background-color&quot;,opts.background);</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>切记：为了不和其他插件对共享$这个符号的冲突，尽量用下面这个包起来，妥妥的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(function($)&#123;</div><div class="line">	</div><div class="line">&#125;)(jQuery);</div></pre></td></tr></table></figure>
<p>调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(&quot;#id&quot;).hi(&#123;&quot;background&quot;: &quot;red&quot;&#125;);</div></pre></td></tr></table></figure>
<h3 id="jQuery的链式调用"><a href="#jQuery的链式调用" class="headerlink" title="jQuery的链式调用"></a>jQuery的链式调用</h3><pre><code>大家都知道，也都在使用jQuery的链式调用，很优雅，那我们自己的插件可以这样调用吗？
能不能，我们来做个实验,直接执行如下：
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(&quot;#id&quot;).hi(&#123;&quot;background&quot;: &quot;red&quot;&#125;).html();</div></pre></td></tr></table></figure>
<pre><code>不好意思，你会看到令人厌烦的异常
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Uncaught TypeError: Cannot read property &apos;html&apos; of undefined at &lt;anonymous&gt;:1:46</div></pre></td></tr></table></figure>
<pre><code>也就是说，我们自己的插件打破了jQuery的链式传递，怎么办呢？其实很简单，在函数最后添加如下：
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">return this.each(function() &#123;</div><div class="line">  // Using return allows for chainability</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="最后完整代码"><a href="#最后完整代码" class="headerlink" title="最后完整代码"></a>最后完整代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">(function($)&#123;</div><div class="line">  $.fn.extend(&#123;</div><div class="line">    hi: function (options) &#123;</div><div class="line">      var defaults=&#123;&#125;;</div><div class="line">      var opts = $.extend(defaults,options);</div><div class="line">      console.log(opts);</div><div class="line">      $(this).css(&quot;background-color&quot;, opts.background);</div><div class="line">      return this.each(function() &#123;</div><div class="line">        // Using return allows for chainability</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;)(jQuery);</div></pre></td></tr></table></figure>
<h3 id="注意：如果你直接-hi-来调用，会抛出异常"><a href="#注意：如果你直接-hi-来调用，会抛出异常" class="headerlink" title="注意：如果你直接 $.hi() 来调用，会抛出异常"></a>注意：如果你直接 $.hi() 来调用，会抛出异常</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Uncaught TypeError: $.hi is not a functionx at &lt;anonymous&gt;:1:3</div></pre></td></tr></table></figure>
<p>这也证实了hi方法只是赋予了选择器的实例上，那么我们想给$(jQuery)对象赋予自定义功能，该如何实现呢？</p>
<p>###jQuery类级别的自定义插件,也可以理解为静态方法，工具类。</p>
<pre><code>跟之前比较类似，如下：
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(function($)&#123;</div><div class="line">  $.extend(&#123;</div><div class="line">    hiDate: function () &#123;</div><div class="line">      return new Date().toJSON().slice(0,10)</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;)(jQuery);</div></pre></td></tr></table></figure>
<pre><code>调用方式
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$.hiDate();</div></pre></td></tr></table></figure>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>没事写写代码，写写后端，写写前端，哦，js已经不仅限于前端啦：）～
 :)~
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;以前写过javascript，但都是临时更改，没怎么太研究怎么去写好，怎么去封装，还有jQuery，都是拿来即用，
根本就没想过去写插件，主要吧，都是作后端的内容，很少写前端代码。其实写写前端挺有意思的，顺便心血来潮，
整个jQuery插件玩玩：）～
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Frontend" scheme="http://www.nealma.com/categories/Frontend/"/>
    
    
      <category term="JavaScript" scheme="http://www.nealma.com/tags/JavaScript/"/>
    
      <category term="jQuery" scheme="http://www.nealma.com/tags/jQuery/"/>
    
  </entry>
  
  <entry>
    <title>Nginx | ERR_CONTENT_LENGTH_MISMATCH</title>
    <link href="http://www.nealma.com/2017/06/04/nginx-example-work-3-temp-proxy/"/>
    <id>http://www.nealma.com/2017/06/04/nginx-example-work-3-temp-proxy/</id>
    <published>2017-06-04T03:46:45.000Z</published>
    <updated>2017-07-01T03:58:15.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>访问网页的时候，经常出现 net::ERR_CONTENT_LENGTH_MISMATCH这个问题，一开始也为是某些文件过大导致的，
还特意把大的资源文件放在CDN上，肯定不行了。
可是后来发现不管文件大小，都会偶尔报这个错，后来经过Google，才知道是nginx的问题，学无止境。
</code></pre><a id="more"></a>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><pre><code>nginx的工作进程对大文件做了缓存，存储在/var/lib/nginx/tmp/proxy下，通过查看error.log文件可以看到，
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2017/06/04 15:30:29 [crit] 24446#0: *21029 open() &quot;/var/lib/nginx/tmp/proxy/1/14/0000000141&quot; failed (13: Permission denied) while reading upstream,</div></pre></td></tr></table></figure>
<p>也即是nginx的启动进程用户没有权限访问proxy的目录，导致读取文件失败，可以变更nginx.conf中的user为nginx，若果<br>想使用自定义用户xxx，那需要给xxx授权，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chown -R xxx /var/lib/nginx/tmp/proxy</div></pre></td></tr></table></figure></p>
<p>重新启动nginx, 问题解决。</p>
]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;访问网页的时候，经常出现 net::ERR_CONTENT_LENGTH_MISMATCH这个问题，一开始也为是某些文件过大导致的，
还特意把大的资源文件放在CDN上，肯定不行了。
可是后来发现不管文件大小，都会偶尔报这个错，后来经过Google，才知道是nginx的问题，学无止境。
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Nginx" scheme="http://www.nealma.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://www.nealma.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十五) PubSub Messaging with Spring Data Redis</title>
    <link href="http://www.nealma.com/2017/06/04/spring-boot-15-pub-sub/"/>
    <id>http://www.nealma.com/2017/06/04/spring-boot-15-pub-sub/</id>
    <published>2017-06-04T01:46:45.000Z</published>
    <updated>2017-09-14T01:08:23.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>异构系统之间如何解偶和很好的连接呢？发布订阅模式是个很好的选择。
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>发布订阅是一种典型的异步通信模型，可以让消息的发布者和订阅者充分解耦。
Spring Boot中，使用Redis很容易实现一个发布订阅系统，如果你想用，看这一篇就够了。
</code></pre><p><a href="http://www.baeldung.com/spring-data-redis-pub-sub" target="_blank" rel="external">参考文章</a></p>
<p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA<br>Build: Maven</p>
<p><strong>本文依赖前文的CacheConfig.java文件</strong></p>
<h3 id="加入依赖"><a href="#加入依赖" class="headerlink" title="加入依赖"></a>加入依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h3 id="Redis-Configuration"><a href="#Redis-Configuration" class="headerlink" title="Redis Configuration"></a>Redis Configuration</h3><ul>
<li><p>MessageListenerAdapter/MessageListener/RedisMessageSubscriber</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">MessageListenerAdapter messageListener() &#123; </div><div class="line">    return new MessageListenerAdapter(new RedisMessageSubscriber());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>RedisMessageListenerContainer<br>– “handles the low level details of listening, converting and message dispatching.”–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">RedisMessageListenerContainer redisContainer() &#123;</div><div class="line">    RedisMessageListenerContainer container </div><div class="line">      = new RedisMessageListenerContainer(); </div><div class="line">    container.setConnectionFactory(jedisConnectionFactory()); </div><div class="line">    container.addMessageListener(messageListener(), topic()); </div><div class="line">    return container; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>RedisMessagePublisher (redisTemplate and topic as constructor arguments)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">RedisMessagePublisher redisPublisher() &#123; </div><div class="line">    return new RedisMessagePublisher(redisTemplate(), topic());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Set up Topic</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">ChannelTopic topic() &#123;</div><div class="line">    return new ChannelTopic(&quot;messageQueue&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="用到的一些类"><a href="#用到的一些类" class="headerlink" title="用到的一些类"></a>用到的一些类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">#MessagePublisher.java</div><div class="line">public interface MessagePublisher &#123;</div><div class="line">    void publish(final String message);</div><div class="line">&#125;</div><div class="line"></div><div class="line">#RedisMessagePublisher.java</div><div class="line">@Service</div><div class="line">public class RedisMessagePublisher implements MessagePublisher &#123;</div><div class="line">    @Autowired</div><div class="line">    private RedisTemplate&lt;Object, Object&gt; redisTemplate;</div><div class="line">    @Autowired</div><div class="line">    private ChannelTopic topic;</div><div class="line"></div><div class="line">    public RedisMessagePublisher(final RedisTemplate&lt;Object, Object&gt; redisTemplate, final ChannelTopic topic) &#123;</div><div class="line">        this.redisTemplate = redisTemplate;</div><div class="line">        this.topic = topic;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void publish(final String message) &#123;</div><div class="line">        redisTemplate.convertAndSend(topic.getTopic(), message);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#RedisMessageSubscriber.java</div><div class="line">@Service</div><div class="line">public class RedisMessageSubscriber implements MessageListener&#123;</div><div class="line">    public static List&lt;String&gt; messageList = new ArrayList();</div><div class="line"></div><div class="line">    public void onMessage(final Message message, final byte[] pattern) &#123;</div><div class="line">        messageList.add(message.toString());</div><div class="line">        System.out.println(&quot;Message received: &quot; + new String(message.getBody()));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@RunWith(SpringJUnit4ClassRunner.class)</div><div class="line">@SpringBootTest(classes = Application.class)</div><div class="line">public class RedisMessageListenerIntegrationTest &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private RedisMessagePublisher redisMessagePublisher;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void testOnMessage() throws Exception &#123;</div><div class="line">        String message = &quot;Message &quot; + UUID.randomUUID();</div><div class="line">        redisMessagePublisher.publish(message);</div><div class="line">        Thread.sleep(100);</div><div class="line">        assertTrue(RedisMessageSubscriber.messageList.get(0).contains(message));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>～：）～～～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;异构系统之间如何解偶和很好的连接呢？发布订阅模式是个很好的选择。
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="PubSub" scheme="http://www.nealma.com/tags/PubSub/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十四) Spring Boot Use Redis As Cache</title>
    <link href="http://www.nealma.com/2017/06/03/spring-boot-14-redis-cache/"/>
    <id>http://www.nealma.com/2017/06/03/spring-boot-14-redis-cache/</id>
    <published>2017-06-03T01:46:45.000Z</published>
    <updated>2017-09-12T02:15:01.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>随着后期流量的增加，避免不了要上缓存。不要担心，幸好你遇到了Spring Boot，让你轻松搞定缓存。
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>Spring Boot中提供了目前市面上的所有缓存支持，然而在实际生产中，大都会用redis来作为外部缓存的首选。
为神马要用缓存呢，就一字“快”，可以减少频繁的数据库操作，节省资源。
下面我们看看如何实现缓存。
</code></pre><p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA<br>Build: Maven</p>
<h3 id="加入依赖"><a href="#加入依赖" class="headerlink" title="加入依赖"></a>加入依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h3 id="Spring中的CacheManager"><a href="#Spring中的CacheManager" class="headerlink" title="Spring中的CacheManager"></a>Spring中的CacheManager</h3><p>Spring中支持囊括了个大缓存组件，无需复杂的处理，都能完美支持。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Any compliant JSR-107 (JCache) provider</div><div class="line"></div><div class="line">EhCache</div><div class="line"></div><div class="line">Hazelcast</div><div class="line"></div><div class="line">Infinispan</div><div class="line"></div><div class="line">Couchbase</div><div class="line"></div><div class="line">Redis</div><div class="line"></div><div class="line">Caffeine</div><div class="line"></div><div class="line">Simple provider based on ConcurrentHashMap</div><div class="line"></div><div class="line">Generic provider based on org.springframework.Cache bean definition(s)</div></pre></td></tr></table></figure></p>
<h3 id="这里我们只是介绍RedisCacheManager实现集中缓存的方式"><a href="#这里我们只是介绍RedisCacheManager实现集中缓存的方式" class="headerlink" title="这里我们只是介绍RedisCacheManager实现集中缓存的方式"></a>这里我们只是介绍RedisCacheManager实现集中缓存的方式</h3><ul>
<li><p>Java-based Configuration<br>我们需要创建一个Redis的配置类，使用@EnableCaching注解来告诉你的App开启缓存支持，这里面包括具体的CacheManager，<br>同时还要有factory和redisTesmplate来和redis进行通信。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">@EnableCaching</div><div class="line">public class CacheConfig extends CachingConfigurerSupport&#123;</div><div class="line">    public static final Logger LOGGER = LoggerFactory.getLogger(CacheConfig.class);</div><div class="line">    @Value(&quot;$&#123;spring.redis.host&#125;&quot;)</div><div class="line">    private String redisHostName = &quot;localhost&quot;;</div><div class="line">    @Value(&quot;$&#123;spring.redis.port&#125;&quot;)</div><div class="line">    private  int redisPort = 6379;</div><div class="line">    @Value(&quot;$&#123;spring.redis.password&#125;&quot;)</div><div class="line">    private String redisPasswd = &quot;******&quot;;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public JedisConnectionFactory jedisConnectionFactory() &#123;</div><div class="line">        JedisConnectionFactory factory = new JedisConnectionFactory();</div><div class="line">        factory.setHostName(redisHostName);</div><div class="line">        factory.setPort(redisPort);</div><div class="line">        factory.setPassword(redisPasswd);</div><div class="line">        factory.setUsePool(true);</div><div class="line">        return factory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public RedisTemplate&lt;String, String&gt; redisTemplate(RedisConnectionFactory cf) &#123;</div><div class="line">        RedisTemplate&lt;String, String&gt; redisTemplate = new RedisTemplate();</div><div class="line">        redisTemplate.setConnectionFactory(cf);</div><div class="line">        return redisTemplate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public CacheManager cacheManager(RedisTemplate redisTemplate) &#123;</div><div class="line">        RedisCacheManager cacheManager = new RedisCacheManager(redisTemplate);</div><div class="line"></div><div class="line">        // Number of seconds before expiration. Defaults to unlimited (0)</div><div class="line">        cacheManager.setDefaultExpiration(300);</div><div class="line">        return cacheManager;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>xxxController使用@Cacheable开启缓存,进行测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@RestController</div><div class="line">public class APIController&#123;</div><div class="line"></div><div class="line">    @RequestMapping(&quot;/api/caches/test1&quot;)</div><div class="line">    @Cacheable(&quot;test&quot;)</div><div class="line">    public String cacheTest1(Long userId, String name) &#123;</div><div class="line">        LOGGER.debug(&quot;performing expensive calculation...&quot;);</div><div class="line">        return this.renderJson(MsgOut.success());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Redis存储结果<br>你会发现，在redis的控制台中，存储的key和value都是ascii码，这是因为RedisTemplate使用了基于Java的串行器来进行大部分的操作，包括key和value的序列化。如果你想更改java的序列化和反序列化的设置，可以在这个包下org.springframework.data.redis.serializer，寻找你所需要的串行器。</p>
</li>
</ul>
<h3 id="另一种串行器以及自定义keyGenerator的逻辑"><a href="#另一种串行器以及自定义keyGenerator的逻辑" class="headerlink" title="另一种串行器以及自定义keyGenerator的逻辑"></a>另一种串行器以及自定义keyGenerator的逻辑</h3><p><strong>SpringBoot默认使用SimpleKeyGenerator生成key</strong></p>
<h2 id="如果参数的名字和类型一样，就是出现缓存覆盖的问题，故可以自定义KeyGenerator"><a href="#如果参数的名字和类型一样，就是出现缓存覆盖的问题，故可以自定义KeyGenerator" class="headerlink" title="如果参数的名字和类型一样，就是出现缓存覆盖的问题，故可以自定义KeyGenerator"></a>如果参数的名字和类型一样，就是出现缓存覆盖的问题，故可以自定义KeyGenerator</h2><p>public SimpleKey(Object… elements) {<br>    Assert.notNull(elements, “Elements must not be null”);<br>    this.params = new Object[elements.length];<br>    System.arraycopy(elements, 0, this.params, 0, elements.length);<br>    this.hashCode = Arrays.deepHashCode(this.params);</p>
<h2 id=""><a href="#" class="headerlink" title="}"></a>}</h2><p><strong>自定义KeyGenerator</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">@EnableCaching</div><div class="line">public class CacheConfig extends CachingConfigurerSupport&#123;</div><div class="line">    public static final Logger LOGGER = LoggerFactory.getLogger(CacheConfig.class);</div><div class="line">    @Value(&quot;$&#123;spring.redis.host&#125;&quot;)</div><div class="line">    private String redisHostName = &quot;localhost&quot;;</div><div class="line">    @Value(&quot;$&#123;spring.redis.port&#125;&quot;)</div><div class="line">    private  int redisPort = 6379;</div><div class="line">    @Value(&quot;$&#123;spring.redis.password&#125;&quot;)</div><div class="line">    private String redisPasswd = &quot;******&quot;;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public JedisConnectionFactory jedisConnectionFactory() &#123;</div><div class="line">        JedisConnectionFactory factory = new JedisConnectionFactory();</div><div class="line">        factory.setHostName(redisHostName);</div><div class="line">        factory.setPort(redisPort);</div><div class="line">        factory.setPassword(redisPasswd);</div><div class="line">        factory.setUsePool(true);</div><div class="line">        return factory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public KeyGenerator keyGenerator() &#123;</div><div class="line">        return (o, method, objects) -&gt; &#123;</div><div class="line">            // This will generate a unique key of the class name, the method name,</div><div class="line">            // and all method parameters appended.</div><div class="line">            StringBuilder sb = new StringBuilder();</div><div class="line">            sb.append(o.getClass().getName());</div><div class="line">            sb.append(&quot;:&quot;);</div><div class="line">            sb.append(method.getName());</div><div class="line">            for (Object obj : objects) &#123;</div><div class="line">                sb.append(&quot;:&quot;);</div><div class="line">                sb.append(obj.toString());</div><div class="line">            &#125;</div><div class="line">            return sb.toString();</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public RedisTemplate&lt;String, String&gt; redisTemplate(</div><div class="line">            RedisConnectionFactory factory) &#123;</div><div class="line">        StringRedisTemplate template = new StringRedisTemplate(factory);</div><div class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);</div><div class="line">        ObjectMapper om = new ObjectMapper();</div><div class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</div><div class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</div><div class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</div><div class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</div><div class="line">        template.afterPropertiesSet();</div><div class="line">        return template;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public CacheManager cacheManager(RedisTemplate redisTemplate) &#123;</div><div class="line">        RedisCacheManager cacheManager = new RedisCacheManager(redisTemplate);</div><div class="line"></div><div class="line">        // Number of seconds before expiration. Defaults to unlimited (0)</div><div class="line">        cacheManager.setDefaultExpiration(300);</div><div class="line">        return cacheManager;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我一般喜欢存储json数据，这样可以跨平台，而不是只能java App可以用，未来如果混合了java以外的语言，也能从容应对。</p>
<h3 id="缓存更新和过期-CachePut和-CacheEvict"><a href="#缓存更新和过期-CachePut和-CacheEvict" class="headerlink" title="缓存更新和过期: @CachePut和@CacheEvict"></a>缓存更新和过期: @CachePut和@CacheEvict</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#设置</div><div class="line">@Cacheable(value = &quot;queue&quot;)</div><div class="line">public Queue selectByPK(Long id) &#123;</div><div class="line">	...</div><div class="line">&#125;</div><div class="line"></div><div class="line">#更新</div><div class="line">@CachePut(value = &quot;queue&quot;, key = &quot;#root.targetClass.name + &apos;:selectByPK:&apos; + #result.id&quot;)</div><div class="line">public Queue update(Queue Queue) &#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">#失效or过期</div><div class="line">@CacheEvict(value = &quot;queue&quot;, key = &quot;#root.targetClass.name + &apos;:selectByPK:&apos; + #id&quot;)</div><div class="line">public int delete(Long id) &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SpEL生成key"><a href="#SpEL生成key" class="headerlink" title="SpEL生成key"></a>SpEL生成key</h3><p>Spring还为我们提供了一个root对象可以用来生成key。通过该root对象我们可以获取到以下信息。<br>属性名称    描述    示例<br>methodName    当前方法名    #root.methodName<br>method    当前方法    #root.method.name<br>target    当前被调用的对象    #root.target<br>targetClass    当前被调用的对象的class    #root.targetClass<br>args    当前方法参数组成的数组    #root.args[0]<br>caches    当前被调用的方法使用的Cache     #root.caches[0].name<br>当我们要使用root对象的属性作为key时我们也可以将“#root”省略，因为Spring默认使用的就是root对象的属性。</p>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>～：）～～～
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;随着后期流量的增加，避免不了要上缓存。不要担心，幸好你遇到了Spring Boot，让你轻松搞定缓存。
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="Cache" scheme="http://www.nealma.com/tags/Cache/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十三) 事物处理 Transaction</title>
    <link href="http://www.nealma.com/2017/06/02/spring-boot-13-transaction/"/>
    <id>http://www.nealma.com/2017/06/02/spring-boot-13-transaction/</id>
    <published>2017-06-02T02:46:45.000Z</published>
    <updated>2017-08-23T06:20:35.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>SpringBoot的事务管理（jdbc、jpa、mybatis）
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>SpringBoot的事务管理（jdbc、jpa、mybatis）
Springboot内部提供的事务管理器是根据autoconfigure来进行决定的。
</code></pre><p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA<br>Build: Maven</p>
<h3 id="触发不同的事物管理器"><a href="#触发不同的事物管理器" class="headerlink" title="触发不同的事物管理器"></a>触发不同的事物管理器</h3><ul>
<li>当使用jpa（pom中加入了spring-boot-starter-data-jpa），Springboot会构造一个JpaTransactionManager事务管理器；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#触发HibernateJpaAutoConfiguration（该类继承了JpaBaseConfiguration类）自动配置</div><div class="line">@Bean</div><div class="line">@ConditionalOnMissingBean(PlatformTransactionManager.class)</div><div class="line">public PlatformTransactionManager transactionManager() &#123;</div><div class="line">    return new JpaTransactionManager();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>当我们使用jdbc(pom中加入了spring-boot-starter-jdbc），Springboot会构造一个DataSourceTransactionManager事物管理器；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#触发DataSourceTransactionManagerAutoConfiguration这个自动化配置</div><div class="line">@Bean</div><div class="line">@ConditionalOnMissingBean(&#123;PlatformTransactionManager.class&#125;)</div><div class="line">public DataSourceTransactionManager transactionManager(DataSourceProperties properties) &#123;</div><div class="line">    DataSourceTransactionManager transactionManager = new DataSourceTransactionManager(this.dataSource);</div><div class="line">    if(this.transactionManagerCustomizers != null) &#123;</div><div class="line">        this.transactionManagerCustomizers.customize(transactionManager);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return transactionManager;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这两个接口都实现了PlatformTransactionManager这个接口，PlatformTransactionManager是spring事物管理的核心接口。</p>
<h3 id="手动配置事物管理器"><a href="#手动配置事物管理器" class="headerlink" title="手动配置事物管理器"></a>手动配置事物管理器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@ConditionalOnMissingBean(&#123;PlatformTransactionManager.class&#125;)</div></pre></td></tr></table></figure>
<p>在自动配置类中，我们发现@ConditionalOnMissingBean({PlatformTransactionManager.class})这个注解，什么意思呢？<br>就是如果我们手动配置了事物管理器，spring将不会再为我们构造事物管理器了。</p>
<h3 id="那如果我们使用的是mybatis，如何处理事物呢"><a href="#那如果我们使用的是mybatis，如何处理事物呢" class="headerlink" title="那如果我们使用的是mybatis，如何处理事物呢"></a>那如果我们使用的是mybatis，如何处理事物呢</h3><p>MyBatis 中有两种类型的事务管理器（也就是 type=”[JDBC|MANAGED]”）</p>
<ul>
<li><p>JDBC - 直接使用了 JDBC 的提交和回滚设置，它依赖于从数据源得到的连接来管理事务范围。</p>
</li>
<li><p>MANAGED - 让容器来管理事务的整个生命周期（比如 JEE 应用服务器的上下文）。</p>
</li>
<li><p>SqlSessionFactory mybatis通过这个核心类来管理session，session进行提交和回滚。</p>
</li>
</ul>
<h3 id="使用Spring-MyBatis"><a href="#使用Spring-MyBatis" class="headerlink" title="使用Spring+MyBatis"></a>使用Spring+MyBatis</h3><p>大部分情况下，我们不会单独使用MyBatis，都会结合Spring来使用。这个时候，事物处理统统有Spring来管理</p>
<p>在与Spring、SpringBoot集成时，注意SqlSessionFactory和DataSourceTransactionManager必须给予同一个dataSource,<br>否则不能进行事物管理。</p>
<h3 id="举个列子"><a href="#举个列子" class="headerlink" title="举个列子"></a>举个列子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">@MapperScan(DataSourceConfig.PACKAGE)</div><div class="line">public class DataSourceConfig &#123;</div><div class="line"></div><div class="line">    // 精确到 master 目录，以便跟其他数据源隔离</div><div class="line">    static final String PACKAGE = &quot;com.x.*.dao&quot;;</div><div class="line">    static final String MAPPER_LOCATION = &quot;classpath*:**/mappers/*.xml&quot;;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</div><div class="line">    private String url;</div><div class="line">    @Value(&quot;$&#123;spring.datasource.username&#125;&quot;)</div><div class="line">    private String username;</div><div class="line">    @Value(&quot;$&#123;spring.datasource.password&#125;&quot;)</div><div class="line">    private String password;</div><div class="line">    @Value(&quot;$&#123;spring.datasource.driver-class-name&#125;&quot;)</div><div class="line">    private String driver;</div><div class="line"></div><div class="line"></div><div class="line">    @Bean(name = &quot;dataSource&quot;)</div><div class="line">    public DataSource dataSource() &#123;</div><div class="line">        //DruidDataSource dataSource = new DruidDataSource();//alibaba druid datasource</div><div class="line">        DriverManagerDataSource dataSource = new DriverManagerDataSource();</div><div class="line">        dataSource.setDriverClassName(driver);</div><div class="line">        dataSource.setUrl(url);</div><div class="line">        dataSource.setUsername(username);</div><div class="line">        dataSource.setPassword(password);</div><div class="line">        return dataSource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean(name = &quot;transactionManager&quot;)</div><div class="line">    public DataSourceTransactionManager transactionManager() &#123;</div><div class="line">        return new DataSourceTransactionManager(dataSource());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean(name = &quot;sqlSessionFactory&quot;)</div><div class="line">    public SqlSessionFactory sqlSessionFactory(@Qualifier(&quot;dataSource&quot;) DataSource dataSource)</div><div class="line">            throws Exception &#123;</div><div class="line">        final SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();</div><div class="line">        sessionFactory.setDataSource(dataSource);</div><div class="line">        sessionFactory.setMapperLocations(new PathMatchingResourcePatternResolver()</div><div class="line">                .getResources(DataSourceConfig.MAPPER_LOCATION));</div><div class="line">        return sessionFactory.getObject();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="可以使用多个事物处理器"><a href="#可以使用多个事物处理器" class="headerlink" title="可以使用多个事物处理器()"></a>可以使用多个事物处理器()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">public class DatabaseConfiguration &#123;</div><div class="line"> </div><div class="line">    @Bean</div><div class="line">    public PlatformTransactionManager transactionManager1(EntityManagerFactory entityManagerFactory) &#123;</div><div class="line">        return new JpaTransactionManager(entityManagerFactory);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    @Bean</div><div class="line">    public PlatformTransactionManager transactionManager2(DataSource dataSource) &#123;</div><div class="line">        return new DataSourceTransactionManager(dataSource);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="在具体使用-Transactional时需要制定处理器的名字"><a href="#在具体使用-Transactional时需要制定处理器的名字" class="headerlink" title="在具体使用@Transactional时需要制定处理器的名字"></a>在具体使用@Transactional时需要制定处理器的名字</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># @Transactional(value=&quot;transactionManager&quot;, rollbackFor = Exception.class)</div><div class="line"># @Transactional</div><div class="line"></div><div class="line">@Transactional(value=&quot;transactionManager1&quot;)</div><div class="line">public void insert() &#123;</div><div class="line">    insert();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="继承TransactionManagementConfigurer类，覆盖默认事物处理器方法"><a href="#继承TransactionManagementConfigurer类，覆盖默认事物处理器方法" class="headerlink" title="继承TransactionManagementConfigurer类，覆盖默认事物处理器方法"></a>继承TransactionManagementConfigurer类，覆盖默认事物处理器方法</h3><p><strong>在Spring容器中，我们手工注解@Bean 将被优先加载，框架不会重新实例化其他的 PlatformTransactionManager 实现类。</strong></p>
<p><strong>然后在Service中，被 @Transactional 注解的方法，将支持事务。如果注解在类上，则整个类的所有方法都默认支持事务。</strong></p>
<p><strong>对于同一个工程中存在多个事务管理器要怎么处理，请看下面的实例，具体说明请看代码中的注释。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// 实现接口 TransactionManagementConfigurer 方法，其返回值代表在拥有多个事务管理器的情况下默认使用的事务管理器</div><div class="line">    @Override</div><div class="line">    public PlatformTransactionManager annotationDrivenTransactionManager() &#123;</div><div class="line">        return txManager2;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>如果Spring容器中存在多个 PlatformTransactionManager 实例，并且没有实现接口 TransactionManagementConfigurer 指定默认值，在我们在方法上使用注解 @Transactional 的时候，就必须要用value指定，如果不指定，则会抛出异常。</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;SpringBoot的事务管理（jdbc、jpa、mybatis）
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="Transaction" scheme="http://www.nealma.com/tags/Transaction/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十二) 获取request和session</title>
    <link href="http://www.nealma.com/2017/06/01/spring-boot-12-not-thread/"/>
    <id>http://www.nealma.com/2017/06/01/spring-boot-12-not-thread/</id>
    <published>2017-06-01T03:46:45.000Z</published>
    <updated>2017-09-21T06:08:41.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>Spring Boot中获取全局request，咩有controller中获取，而是在一个工具类中，
这次也不知是为什么之前根本不需要配置的，但是就是会报一个错，看看神马影响的呢？
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>Spring Boot中获取全局request，咩有controller中获取，而是在一个工具类中，
 这次也不知是为什么之前根本不需要配置的，但是就是会报一个错，看看神马影响的呢？
</code></pre><p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA<br>Build: Maven</p>
<h3 id="获取request"><a href="#获取request" class="headerlink" title="获取request"></a>获取request</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public static HttpServletRequest getRequest()&#123;</div><div class="line">    ServletRequestAttributes servletRequestAttributes = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();</div><div class="line">    return servletRequestAttributes.getRequest();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="可恶的异常来了"><a href="#可恶的异常来了" class="headerlink" title="可恶的异常来了"></a>可恶的异常来了</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">java spring——Getting a &apos;No thread bound request found&apos; error from spring in my web app.</div><div class="line">In this case, use RequestContextListener or RequestContextFilter to expose the current request.</div></pre></td></tr></table></figure>
<h3 id="解决方案-在MvcConfig中注入RequestContextListener"><a href="#解决方案-在MvcConfig中注入RequestContextListener" class="headerlink" title="解决方案: 在MvcConfig中注入RequestContextListener"></a>解决方案: 在MvcConfig中注入RequestContextListener</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">public RequestContextListener requestContextListener() &#123;</div><div class="line">    return new RequestContextListener();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="更新日志-1"><a href="#更新日志-1" class="headerlink" title="更新日志 1"></a>更新日志 1</h3><p><strong>发现是启用了@EnableWebMvc这个注解，这个注解默认做了很多事情。</strong></p>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>慢慢趟，总有趟完的时候...
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;Spring Boot中获取全局request，咩有controller中获取，而是在一个工具类中，
这次也不知是为什么之前根本不需要配置的，但是就是会报一个错，看看神马影响的呢？
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="Session" scheme="http://www.nealma.com/tags/Session/"/>
    
  </entry>
  
  <entry>
    <title>【Response Body】服务器端返回值大小</title>
    <link href="http://www.nealma.com/2017/05/01/work-problerm-9-pk12/"/>
    <id>http://www.nealma.com/2017/05/01/work-problerm-9-pk12/</id>
    <published>2017-05-01T04:46:45.000Z</published>
    <updated>2017-08-21T10:56:10.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>DerInputStream.getLength(): lengthTag=111, too big
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>在开发微信企业付款时，在load证书时，发生DerInputStream.getLength(): lengthTag=111, too big错误，
查了很多才知道，是maven打包惹的祸。
</code></pre><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#在pom.xml中加入这个配置即可</div><div class="line">&lt;plugin&gt;</div><div class="line">    &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;</div><div class="line">    &lt;configuration&gt;</div><div class="line">        &lt;encoding&gt;UTF-8&lt;/encoding&gt;</div><div class="line">        &lt;!-- 过滤后缀为pem、pfx的证书文件 --&gt;</div><div class="line">        &lt;nonFilteredFileExtensions&gt;</div><div class="line">            &lt;nonFilteredFileExtension&gt;pem&lt;/nonFilteredFileExtension&gt;</div><div class="line">            &lt;nonFilteredFileExtension&gt;p12&lt;/nonFilteredFileExtension&gt;</div><div class="line">            &lt;nonFilteredFileExtension&gt;pfx&lt;/nonFilteredFileExtension&gt;</div><div class="line">        &lt;/nonFilteredFileExtensions&gt;</div><div class="line">    &lt;/configuration&gt;</div><div class="line">&lt;/plugin&gt;</div></pre></td></tr></table></figure>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>:)~
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;DerInputStream.getLength(): lengthTag=111, too big
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="work" scheme="http://www.nealma.com/categories/work/"/>
    
    
      <category term="java" scheme="http://www.nealma.com/tags/java/"/>
    
      <category term="maven" scheme="http://www.nealma.com/tags/maven/"/>
    
  </entry>
  
  <entry>
    <title>【Response Body】服务器端返回值大小</title>
    <link href="http://www.nealma.com/2017/05/01/work-problerm-8-server-response-size/"/>
    <id>http://www.nealma.com/2017/05/01/work-problerm-8-server-response-size/</id>
    <published>2017-05-01T03:46:45.000Z</published>
    <updated>2017-07-01T03:20:30.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>有的时候，你会遇到很奇怪的事情，就是请求一切正常，但服务器端就是没有返回值。
特别是上传文件的时候，那到底发生了什么呢？
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>客户端请求报文的大小和服务器端响应报文的大小，在我们的实际项目中，可能会涉及到一下几个方面
</code></pre><h3 id="Nginx设置"><a href="#Nginx设置" class="headerlink" title="Nginx设置"></a>Nginx设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#在http中</div><div class="line">client_max_body_size 30m;</div></pre></td></tr></table></figure>
<h3 id="数据库设置"><a href="#数据库设置" class="headerlink" title="数据库设置"></a>数据库设置</h3><ul>
<li><p>字段长度设置</p>
</li>
<li><p>数据库报文大小设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#在my.cnf中,在[mysqld]段或者mysql的server配置段进行修改。</div><div class="line">max_allowed_packet = 20M</div><div class="line"></div><div class="line">#如果找不到，可以查询</div><div class="line">mysql --help |grep my.cnf</div><div class="line"></div><div class="line">#也可以更改全局变量</div><div class="line">set global max_allowed_packet = 2*1024*1024*10</div><div class="line"></div><div class="line">#不需要重启，可以查看</div><div class="line">show VARIABLES like &apos;%max_allowed_packet%&apos;;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>:)~
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;有的时候，你会遇到很奇怪的事情，就是请求一切正常，但服务器端就是没有返回值。
特别是上传文件的时候，那到底发生了什么呢？
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="work" scheme="http://www.nealma.com/categories/work/"/>
    
    
      <category term="Nginx" scheme="http://www.nealma.com/tags/Nginx/"/>
    
      <category term="大杂烩" scheme="http://www.nealma.com/tags/%E5%A4%A7%E6%9D%82%E7%83%A9/"/>
    
      <category term="数据库" scheme="http://www.nealma.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Boot（十一) not fat jar ,but jar</title>
    <link href="http://www.nealma.com/2017/04/19/spring-boot-11-not-fat-jar/"/>
    <id>http://www.nealma.com/2017/04/19/spring-boot-11-not-fat-jar/</id>
    <published>2017-04-19T03:46:45.000Z</published>
    <updated>2017-07-01T03:58:02.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code>使用spring boot有一段时间了，想抽离出公共的内容，以备后用。
于是写个两个jar，分别为A 和 B，B引用A，发现引用失败，出现&quot;cannot resolve symbol xxx&quot;,
才发现Spring Boot默认都是打包成“fat jar”，那怎么才能打包成普通的jar呢？
</code></pre><a id="more"></a>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><pre><code>使用spring boot有一段时间了，想抽离出公共的内容，以备后用。
于是写个两个jar，分别为A 和 B，B引用A，发现引用失败，出现&quot;cannot resolve symbol xxx&quot;,
才发现Spring Boot默认都是打包成“fat jar”，那怎么才能打包成普通的jar呢？
</code></pre><p>开发环境：<br>OS: Mac 10.11.6<br>IDE: IDEA<br>Build: Maven</p>
<h3 id="直接下面就OK了"><a href="#直接下面就OK了" class="headerlink" title="直接下面就OK了"></a>直接下面就OK了</h3><p><a href="http://docs.spring.io/spring-boot/docs/current/reference/html/howto-build.html#howto-create-a-nonexecutable-jar" target="_blank" rel="external">可以直接看官方文档</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;plugin&gt;</div><div class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</div><div class="line">	&lt;configuration&gt;</div><div class="line">		&lt;classifier&gt;exec&lt;/classifier&gt;</div><div class="line">	&lt;/configuration&gt;</div><div class="line">&lt;/plugin&gt;</div><div class="line">&lt;plugin&gt;</div><div class="line">	&lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;</div><div class="line">	&lt;executions&gt;</div><div class="line">		&lt;execution&gt;</div><div class="line">			&lt;id&gt;exec&lt;/id&gt;</div><div class="line">			&lt;phase&gt;package&lt;/phase&gt;</div><div class="line">			&lt;goals&gt;</div><div class="line">				&lt;goal&gt;jar&lt;/goal&gt;</div><div class="line">			&lt;/goals&gt;</div><div class="line">			&lt;configuration&gt;</div><div class="line">				&lt;classifier&gt;exec&lt;/classifier&gt;</div><div class="line">			&lt;/configuration&gt;</div><div class="line">		&lt;/execution&gt;</div><div class="line">		&lt;execution&gt;</div><div class="line">			&lt;phase&gt;package&lt;/phase&gt;</div><div class="line">			&lt;goals&gt;</div><div class="line">				&lt;goal&gt;jar&lt;/goal&gt;</div><div class="line">			&lt;/goals&gt;</div><div class="line">			&lt;configuration&gt;</div><div class="line">				&lt;!-- Need this to ensure application.yml is excluded --&gt;</div><div class="line">				&lt;forceCreation&gt;true&lt;/forceCreation&gt;</div><div class="line">				&lt;excludes&gt;</div><div class="line">					&lt;exclude&gt;application.yml&lt;/exclude&gt;</div><div class="line">				&lt;/excludes&gt;</div><div class="line">			&lt;/configuration&gt;</div><div class="line">		&lt;/execution&gt;</div><div class="line">	&lt;/executions&gt;</div><div class="line">&lt;/plugin&gt;</div></pre></td></tr></table></figure>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><pre><code>使用频率最多的都列举出来了，够我们用了。
但是程序员就像偷懒，不想每个domain都要写个XxxRepository,写个基础BaseRepository岂不是节省好多事呢，有空在写吧...
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt;使用spring boot有一段时间了，想抽离出公共的内容，以备后用。
于是写个两个jar，分别为A 和 B，B引用A，发现引用失败，出现&amp;quot;cannot resolve symbol xxx&amp;quot;,
才发现Spring Boot默认都是打包成“fat jar”，那怎么才能打包成普通的jar呢？
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Spring Boot" scheme="http://www.nealma.com/categories/Spring-Boot/"/>
    
    
      <category term="Java" scheme="http://www.nealma.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://www.nealma.com/tags/Spring/"/>
    
      <category term="Spring-Boot" scheme="http://www.nealma.com/tags/Spring-Boot/"/>
    
      <category term="module" scheme="http://www.nealma.com/tags/module/"/>
    
  </entry>
  
</feed>
